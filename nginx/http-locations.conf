# Shared HTTP/HTTPS Location Blocks for KprCli
# This file is included by both HTTP and HTTPS server blocks

# Session Tracking Setup (repeated for HTTPS)
set $session_id $cookie_session_id;
if ($session_id = "") {
    set $session_id $request_id$remote_addr;
}

# Set session cookie for new sessions (cannot use add_header in if block)
add_header Set-Cookie "session_id=$session_id; Path=/; HttpOnly; SameSite=Strict; Secure" always;

# Rate Limiting Application
limit_req zone=per_host burst=20 nodelay;
limit_req zone=per_session burst=50 nodelay;
limit_conn conn_limit_per_ip 50;

# Access Logging with Session Tracking
access_log /var/log/nginx/access.log session_tracking;
error_log /var/log/nginx/error.log warn;

# Health Check Endpoint
location /nginx-health {
    access_log off;
    return 200 "nginx healthy (HTTPS)\n";
    add_header Content-Type text/plain;
}

# API Routes with Enhanced Tracking
location /api/ {
    limit_req zone=api_limit burst=10 nodelay;
    
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $request_id;
    proxy_set_header X-Session-ID $session_id;
    proxy_set_header X-Client-IP $remote_addr;
    
    proxy_pass http://kprcli_backend;
    proxy_redirect off;
    proxy_buffering off;
    proxy_cache_bypass $http_upgrade;
    
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
}

# Static Assets
location /_next/static/ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    proxy_pass http://kprcli_backend;
}

# Main Application
location / {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $request_id;
    proxy_set_header X-Session-ID $session_id;
    proxy_set_header X-Client-IP $remote_addr;
    proxy_set_header X-User-Agent $http_user_agent;
    proxy_set_header X-Accept-Language $http_accept_language;
    proxy_set_header X-Accept-Encoding $http_accept_encoding;
    
    proxy_pass http://kprcli_backend;
    proxy_redirect off;
    proxy_buffering off;
    proxy_cache_bypass $http_upgrade;
    
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
}