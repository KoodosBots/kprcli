<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeleKpr Dashboard - NEW CLEAN VERSION</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöÄ</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .dashboard { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background: #2c3e50; color: white; padding: 20px; }
        .sidebar h2 { margin-bottom: 30px; }
        .nav-item { display: block; width: 100%; padding: 12px; margin: 5px 0; background: #34495e; border: none; color: white; cursor: pointer; border-radius: 5px; text-align: left; }
        .nav-item:hover { background: #4a5f7a; }
        .nav-item.active { background: #3498db; }
        .main { flex: 1; padding: 20px; }
        .header { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .content { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .stat-value { font-size: 2em; font-weight: bold; color: #3498db; }
        .stat-label { color: #666; margin-top: 5px; }
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn:hover { opacity: 0.9; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; font-weight: bold; }
        .alert { padding: 15px; margin: 10px 0; border-radius: 5px; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-danger { background: #f8d7da; color: #721c24; }
        .d-none { display: none !important; }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="sidebar">
            <h2>üöÄ TeleKpr Admin</h2>
            <button class="nav-item active" onclick="showSection('dashboard')">üìä Dashboard</button>
            <button class="nav-item" onclick="showSection('customers')">üë• Customers</button>
            <button class="nav-item" onclick="showSection('orders')">üì¶ Orders</button>
            <button class="nav-item" onclick="showSection('users')">üë§ Users</button>
            <button class="nav-item" onclick="showSection('settings')">‚öôÔ∏è Settings</button>
        </div>
        
        <div class="main">
            <div class="header">
                <h1 id="page-title">Dashboard</h1>
                <div id="messages"></div>
            </div>
            
            <div class="content">
                <!-- Dashboard Section -->
                <div id="dashboard-section">
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-value" id="total-customers">-</div>
                            <div class="stat-label">Total Customers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-orders">-</div>
                            <div class="stat-label">Total Orders</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-users">-</div>
                            <div class="stat-label">Total Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="active-subs">-</div>
                            <div class="stat-label">Active Subscriptions</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="refreshStats()">üîÑ Refresh Stats</button>
                </div>
                
                <!-- Customers Section -->
                <div id="customers-section" class="d-none">
                    <button class="btn btn-primary" onclick="loadCustomers()">üîÑ Refresh</button>
                    <div id="customers-content"></div>
                </div>
                
                <!-- Orders Section -->
                <div id="orders-section" class="d-none">
                    <div id="orders-content">Orders will appear here...</div>
                </div>
                
                <!-- Users Section -->
                <div id="users-section" class="d-none">
                    <div id="users-content">Users will appear here...</div>
                </div>
                
                <!-- Settings Section -->
                <div id="settings-section" class="d-none">
                    <h3>API Settings</h3>
                    <p>API Status: <span id="api-status">Checking...</span></p>
                    <button class="btn btn-primary" onclick="testAPI()">Test API</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        // Replace with your actual Supabase credentials
        const supabase = window.supabase.createClient(
            'https://your-project-id.supabase.co',
            'your_supabase_anon_key_here'
        );

        function showMessage(msg, type = 'success') {
            const div = document.createElement('div');
            div.className = `alert alert-${type}`;
            div.textContent = msg;
            document.getElementById('messages').appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        function showSection(section) {
            document.querySelectorAll('[id$="-section"]').forEach(el => el.classList.add('d-none'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`${section}-section`).classList.remove('d-none');
            event.target.classList.add('active');
            
            const titles = {
                dashboard: 'Dashboard',
                customers: 'Customer Management',
                orders: 'Order Management',
                users: 'User Management',
                settings: 'Settings'
            };
            document.getElementById('page-title').textContent = titles[section];
            
            if (section === 'dashboard') refreshStats();
            if (section === 'customers') loadCustomers();
        }

        async function testAPI() {
            try {
                const res = await fetch(`${API_BASE}/api/test`);
                const data = await res.json();
                document.getElementById('api-status').innerHTML = '<span style="color:green">‚úÖ Connected</span>';
                showMessage('API Connected!', 'success');
            } catch (err) {
                document.getElementById('api-status').innerHTML = '<span style="color:red">‚ùå Failed</span>';
                showMessage('API Error: ' + err.message, 'danger');
            }
        }

        async function refreshStats() {
            try {
                // Get all stats from API server instead of direct Supabase
                const [customersRes, ordersRes, usersRes, subsRes] = await Promise.all([
                    fetch(`${API_BASE}/api/customers`),
                    fetch(`${API_BASE}/api/orders`),
                    fetch(`${API_BASE}/api/users`),
                    fetch(`${API_BASE}/api/subscriptions`)
                ]);
                
                const customers = await customersRes.json();
                const orders = await ordersRes.json();
                const users = await usersRes.json();
                const subscriptions = await subsRes.json();
                
                document.getElementById('total-customers').textContent = Array.isArray(customers) ? customers.length : '0';
                document.getElementById('total-orders').textContent = Array.isArray(orders) ? orders.length : '0';
                document.getElementById('total-users').textContent = Array.isArray(users) ? users.length : '0';
                document.getElementById('active-subs').textContent = Array.isArray(subscriptions) ? subscriptions.filter(s => s.status === 'active').length : '0';
                
                showMessage('Stats updated!', 'success');
            } catch (err) {
                showMessage('Error loading stats: ' + err.message, 'danger');
            }
        }

        async function loadCustomers() {
            try {
                console.log(`üìä Loading customers from: ${API_BASE}/api/customers`);
                const res = await fetch(`${API_BASE}/api/customers`);
                const customers = await res.json();
                console.log(`üìä Loaded ${customers.length} customers:`, customers);
                
                let html = '<table><thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
                
                if (!customers.length) {
                    html += '<tr><td colspan="5" style="text-align:center; padding:20px; color:#666;">No customers found</td></tr>';
                } else {
                    customers.forEach(c => {
                        const safeName = (c.full_name || 'N/A').replace(/'/g, "\\'");
                        html += `<tr>
                            <td><strong>${c.full_name || 'N/A'}</strong></td>
                            <td>${c.phone_number || 'N/A'}</td>
                            <td>${c.email || 'N/A'}</td>
                            <td>${new Date(c.created_at).toLocaleDateString()}</td>
                            <td><button class="btn btn-danger" onclick="deleteCustomer('${c.id}', '${safeName}')">üóëÔ∏è Delete</button></td>
                        </tr>`;
                    });
                }
                
                html += '</tbody></table>';
                document.getElementById('customers-content').innerHTML = html;
                showMessage(`üìä Loaded ${customers.length} customers`, 'success');
            } catch (err) {
                console.error('‚ùå Error loading customers:', err);
                showMessage('‚ùå Error loading customers: ' + err.message, 'danger');
            }
        }

        async function deleteCustomer(id, name) {
            if (!confirm(`‚ö†Ô∏è Delete customer "${name}"?\n\nThis cannot be undone!`)) return;
            
            console.log(`üóëÔ∏è Deleting customer: ${id} (${name})`);
            showMessage(`Deleting customer: ${name}...`, 'info');
            
            try {
                console.log(`Making DELETE request to: ${API_BASE}/api/customers/${id}`);
                const res = await fetch(`${API_BASE}/api/customers/${id}`, { 
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log(`Response status: ${res.status}`);
                const result = await res.json();
                console.log(`Response data:`, result);
                
                if (result.success !== false) {
                    showMessage(`‚úÖ Customer "${name}" deleted successfully!`, 'success');
                    console.log(`‚úÖ Customer deleted, refreshing list...`);
                    setTimeout(() => {
                        loadCustomers();
                        refreshStats();
                    }, 500);
                } else {
                    showMessage(`‚ùå Delete failed: ${result.error || result.message}`, 'danger');
                }
            } catch (err) {
                console.error(`‚ùå Delete error:`, err);
                showMessage(`‚ùå Delete failed: ${err.message}`, 'danger');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('NEW Dashboard loaded!');
            testAPI();
            refreshStats();
        });
    </script>
</body>
</html>