<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeleKpr Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS Variables for Theme Colors */
        :root {
            /* Light Theme */
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8fafc;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border-color: #e2e8f0;
            --border-light: #ddd;
            --shadow: rgba(0,0,0,0.1);
            --shadow-modal: rgba(0,0,0,0.5);
            --accent-primary: #667eea;
            --accent-primary-hover: #5a67d8;
            --accent-success: #38a169;
            --accent-success-hover: #2f855a;
            --accent-danger: #e53e3e;
            --accent-danger-hover: #c53030;
            --accent-warning: #f6ad55;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            
            /* Status Colors (same for both themes) */
            --status-pending-bg: #fed7aa;
            --status-pending-text: #c05621;
            --status-processing-bg: #bfdbfe;
            --status-processing-text: #1e40af;
            --status-assigned-bg: #d9f99d;
            --status-assigned-text: #65a30d;
            --status-completed-bg: #bbf7d0;
            --status-completed-text: #059669;
            --status-cancelled-bg: #fecaca;
            --status-cancelled-text: #dc2626;
            
            /* Form Elements */
            --input-bg: #ffffff;
            --input-border: #ddd;
            --input-focus: #667eea;
            
            /* Charts */
            --chart-bg: transparent;
            --chart-grid: #e2e8f0;
            --chart-text: #666666;
            
            /* Layout Variables */
            --header-height: 60px;
            --tab-bar-height: auto;
            --header-z-index: 100;
            --tab-bar-z-index: 99;
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border-color: #475569;
            --border-light: #64748b;
            --shadow: rgba(0,0,0,0.3);
            --shadow-modal: rgba(0,0,0,0.8);
            --accent-primary: #8b5cf6;
            --accent-primary-hover: #7c3aed;
            --accent-success: #10b981;
            --accent-success-hover: #059669;
            --accent-danger: #ef4444;
            --accent-danger-hover: #dc2626;
            --accent-warning: #f59e0b;
            --gradient-primary: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            
            /* Form Elements Dark */
            --input-bg: #334155;
            --input-border: #475569;
            --input-focus: #8b5cf6;
            
            /* Charts Dark */
            --chart-bg: transparent;
            --chart-grid: #475569;
            --chart-text: #cbd5e1;
        }

        /* Log viewer enhancements */
        .log-line {
            padding: 2px 0;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .log-line-new {
            background: var(--status-completed-bg);
            border-left-color: var(--accent-success);
            animation: highlightNew 2s ease-out;
        }

        @keyframes highlightNew {
            0% {
                background: var(--accent-success);
                color: white;
            }
            100% {
                background: var(--status-completed-bg);
                color: var(--status-completed-text);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Login Form */
        .login-container {
            background: var(--gradient-primary);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-box {
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px var(--shadow);
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border-color);
        }

        .login-box h1 {
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--input-border);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--input-focus);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .login-btn:hover {
            background: var(--accent-primary-hover);
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 4px var(--shadow);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 200;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            height: 60px;
        }

        .header-center {
            display: flex;
            gap: 5px;
            flex: 1;
            justify-content: center;
            margin: 0 30px;
            flex-wrap: wrap;
        }

        .nav-tab {
            display: flex;
            align-items: center;
            gap: 4px;
            background: none;
            border: none;
            padding: 6px 12px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            border-radius: 6px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
            border-color: var(--border-color);
        }

        .nav-tab.active {
            color: var(--accent-primary);
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
        }

        .nav-tab .icon {
            font-size: 16px;
        }

        /* Modern Tab Bar Styles */
        .tab-bar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 4px var(--shadow);
            position: sticky;
            top: var(--header-height);
            z-index: var(--tab-bar-z-index);
            transition: transform 0.3s ease;
        }

        .tab-container {
            display: flex;
            overflow-x: auto;
            scroll-behavior: smooth;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding: 8px 20px;
            gap: 12px;
        }

        .tab-container::-webkit-scrollbar {
            display: none;
        }

        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            background: none;
            border: none;
            padding: 12px 16px;
            min-width: 80px;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
            white-space: nowrap;
        }

        .tab-item:hover {
            background: var(--bg-tertiary);
            transform: translateY(-2px);
        }

        .tab-item.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-hover));
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .tab-icon {
            font-size: 20px;
            transition: transform 0.3s ease;
        }

        .tab-item:hover .tab-icon {
            transform: scale(1.1);
        }

        .tab-text {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .tab-item.active .tab-text {
            color: white;
            font-weight: 600;
        }

        .tab-item:hover .tab-text {
            color: var(--text-primary);
        }

        /* Navigation Collapse Styles */
        .nav-collapse-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .nav-collapse-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Collapsed state */
        .tab-bar.collapsed {
            transform: translateY(-100%);
        }

        /* Show collapse button on smaller screens */
        @media (max-width: 1024px) {
            .nav-collapse-btn {
                display: block;
            }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .tab-container {
                padding: 8px 16px;
                gap: 8px;
            }
            
            .tab-item {
                min-width: 70px;
                padding: 10px 12px;
            }
            
            .tab-icon {
                font-size: 18px;
            }
            
            .tab-text {
                font-size: 11px;
            }
            
            /* Auto-collapse on mobile */
            .tab-bar {
                transform: translateY(-100%);
            }
            
            .tab-bar.expanded {
                transform: translateY(0);
            }
        }

        .header h1 {
            color: var(--text-primary);
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--accent-primary);
            color: white;
        }

        .logout-btn {
            background: var(--accent-danger);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .logout-btn:hover {
            background: var(--accent-danger-hover);
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .sidebar ul {
            list-style: none;
            margin: 0;
            padding: 20px 0;
        }

        .sidebar li {
            margin: 0;
        }

        .sidebar a {
            display: block;
            padding: 12px 24px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .sidebar a:hover,
        .sidebar a.active {
            background: var(--bg-tertiary);
            color: var(--accent-primary);
            border-left-color: var(--accent-primary);
        }

        /* Main Content */
        .content {
            flex: 1;
            padding: 30px;
            background: var(--bg-primary);
            overflow-y: auto;
        }

        .page {
            display: none;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px var(--shadow);
            border: 1px solid var(--border-color);
        }

        .page.active {
            display: block;
        }

        .page h2 {
            color: var(--text-primary);
            margin: 0 0 20px 0;
            font-size: 24px;
            font-weight: 600;
        }

        /* Cards and Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px var(--shadow);
        }

        .stat-card h3 {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            margin: 0 0 8px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            color: var(--text-primary);
            font-size: 28px;
            font-weight: 700;
            margin: 0;
        }

        /* Tables */
        .table-container {
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow-x: auto;
            overflow-y: hidden;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px var(--shadow);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: visible;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px var(--shadow);
        }

        .table th,
        .table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
            vertical-align: middle;
        }

        .table th {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .table td {
            color: var(--text-secondary);
        }

        .table tbody tr:hover {
            background: var(--bg-tertiary);
        }

        /* Status badges */
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status.pending {
            background: var(--status-pending-bg);
            color: var(--status-pending-text);
        }

        .status.processing {
            background: var(--status-processing-bg);
            color: var(--status-processing-text);
        }

        .status.assigned {
            background: var(--status-assigned-bg);
            color: var(--status-assigned-text);
        }

        .status.completed {
            background: var(--status-completed-bg);
            color: var(--status-completed-text);
        }

        .status.cancelled {
            background: var(--status-cancelled-bg);
            color: var(--status-cancelled-text);
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-primary-hover);
        }

        .btn-success {
            background: var(--accent-success);
            color: white;
        }

        .btn-success:hover {
            background: var(--accent-success-hover);
        }

        .btn-danger {
            background: var(--accent-danger);
            color: white;
        }

        .btn-danger:hover {
            background: var(--accent-danger-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--accent-primary);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
        }

        /* User Selection Table Styles */
        .user-selection-row:hover {
            background: var(--bg-secondary);
        }

        .user-selection-row td {
            padding: 10px;
            vertical-align: middle;
        }

        .admin-badge {
            background: var(--accent-primary);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 8px;
        }

        /* Forms */
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--input-border);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--input-focus);
        }

        /* Broadcast styles */
        .broadcast-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-container,
        .preview-container,
        .result-container {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .form-help {
            display: block;
            margin-top: 5px;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .preview-box {
            margin-top: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .alert-success {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid rgba(40, 167, 69, 0.3);
            color: var(--text-primary);
        }

        .alert-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            color: var(--text-primary);
        }

        .alert-error {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .broadcast-container {
                grid-template-columns: 1fr;
            }
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: var(--shadow-modal);
        }

        .modal-content {
            background: var(--bg-secondary);
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h3 {
            color: var(--text-primary);
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .close {
            color: var(--text-tertiary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: var(--accent-danger);
        }

        /* Alerts */
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: var(--status-completed-bg);
            color: var(--status-completed-text);
            border-left-color: var(--accent-success);
        }

        .alert-error {
            background: var(--status-cancelled-bg);
            color: var(--status-cancelled-text);
            border-left-color: var(--accent-danger);
        }

        .alert-warning {
            background: var(--status-pending-bg);
            color: var(--status-pending-text);
            border-left-color: var(--accent-warning);
        }

        /* Loading states */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading::after {
            content: "";
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                order: 2;
            }
            
            .content {
                order: 1;
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .header {
                padding: 15px 20px;
            }
            
            .modal-content {
                margin: 10% auto;
                padding: 20px;
            }
        }

        /* Chart containers */
        .chart-container {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .chart-container h3 {
            color: var(--text-primary);
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: 600;
        }

        .container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--gradient-primary);
        }

        .login-form {
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px var(--shadow);
            width: 100%;
            max-width: 400px;
        }

        .login-form h2 {
            margin-bottom: 30px;
            text-align: center;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            font-size: 16px;
            background-color: var(--input-bg);
            color: var(--text-primary);
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: var(--input-focus);
            box-shadow: 0 0 0 3px rgba(var(--accent-primary), 0.1);
        }

        .btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: var(--accent-primary-hover);
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: var(--text-tertiary);
            cursor: not-allowed;
            transform: none;
        }

        .btn.danger {
            background: var(--accent-danger);
        }

        .btn.danger:hover {
            background: var(--accent-danger-hover);
        }

        .btn.success {
            background: var(--accent-success);
        }

        .btn.success:hover {
            background: var(--accent-success-hover);
        }

        .btn.small {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Status buttons */
        .status-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }

        .status-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            border: 2px solid transparent;
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .status-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--shadow);
        }

        .status-btn.selected {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
            color: white;
        }

        .status-btn .icon {
            font-size: 18px;
        }

        /* Modal form elements */
        .modal textarea,
        .modal input[type="text"],
        .modal input[type="email"],
        .modal input[type="tel"],
        .modal input[type="number"] {
            background: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--input-border);
            border-radius: 6px;
            padding: 10px;
            width: 100%;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .modal textarea:focus,
        .modal input:focus {
            outline: none;
            border-color: var(--input-focus);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .modal label {
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 5px;
            display: block;
        }

        .modal .form-group {
            margin-bottom: 15px;
        }

        .modal .modal-body {
            color: var(--text-primary);
        }

        .error-message {
            color: #e53e3e;
            margin-top: 10px;
            text-align: center;
            font-size: 14px;
        }

        /* Dashboard */
        .dashboard {
            display: none;
            background: var(--bg-primary);
            min-height: 100vh;
            padding-top: 60px;
        }


        .main-container {
            margin-left: 0;
            padding: 20px;
            min-height: calc(100vh - 60px);
            max-width: none;
        }

        /* Tabs */
        .tabs {
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .tab-buttons {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .tab-button {
            padding: 15px 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab-button.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        .tab-button:hover {
            color: var(--accent-primary);
            background: var(--bg-tertiary);
        }

        .tab-content {
            padding: 20px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Remove padding for tabs with Excel tables */
        #ordersTab, #usersTab, #customersTab {
            padding: 0;
        }

        /* Tables - Fixed Styles */
        .table-wrapper {
            overflow-x: auto;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px var(--shadow);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
            background: var(--bg-secondary);
        }

        #customersTable {
            min-width: 1600px; /* Wider table for all customer fields */
        }

        .data-table th,
        .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            color: var(--text-secondary);
        }

        .data-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .data-table tbody tr:hover {
            background: var(--bg-tertiary);
        }

        .data-table tbody tr:nth-child(even) {
            background: rgba(0, 0, 0, 0.02);
        }

        .data-table tbody tr:nth-child(even):hover {
            background: var(--bg-tertiary);
        }

        /* Excel-like table styles */
        .excel-table-container {
            width: 100%;
            height: calc(100vh - 140px);
            overflow: auto;
            background: transparent;
            border: none;
            border-radius: 0;
            box-shadow: none;
            margin: 0;
            padding: 0;
            position: relative;
        }

        .excel-table {
            width: 100%;
            min-width: 1200px;
            border-collapse: collapse;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            font-size: 13px;
            line-height: 1.4;
            background: var(--bg-secondary);
            border: none;
        }

        .excel-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--bg-tertiary);
            border-bottom: 2px solid var(--border-color);
        }

        .excel-table th {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 12px;
            text-align: left;
            padding: 10px 12px;
            border-right: 1px solid var(--border-color);
            border-bottom: 2px solid var(--border-color);
            white-space: nowrap;
            user-select: none;
            cursor: pointer;
            position: relative;
        }

        .excel-table th:last-child {
            border-right: none;
            min-width: 80px;
            text-align: center;
        }

        .excel-table th:hover {
            background: var(--bg-primary);
        }

        .excel-table td {
            padding: 8px 12px;
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            white-space: nowrap;
            vertical-align: middle;
        }
        
        .excel-table td:not(:last-child) {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .excel-table td:last-child {
            border-right: none;
            min-width: 80px;
            text-align: center;
        }

        .excel-table tbody tr {
            transition: background-color 0.1s ease;
        }

        .excel-table tbody tr:hover {
            background: var(--bg-primary);
        }

        .excel-table tbody tr:nth-child(even) {
            background: var(--bg-tertiary);
        }

        .excel-table tbody tr:nth-child(even):hover {
            background: var(--bg-primary);
        }

        /* Three dots menu styles */
        .actions-menu {
            position: relative;
            display: inline-block;
            white-space: nowrap;
        }

        .menu-trigger {
            background: transparent;
            border: 1px solid transparent;
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 20px;
            font-weight: bold;
            line-height: 1;
            transition: all 0.15s ease;
            display: inline-block;
            min-width: 30px;
            text-align: center;
        }

        .menu-trigger:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .dropdown-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-shadow: 0 8px 24px var(--shadow);
            z-index: 2000;
            min-width: 140px;
            padding: 4px 0;
            margin-top: 2px;
            display: none;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            display: block;
            width: 100%;
            padding: 6px 12px;
            background: none;
            border: none;
            text-align: left;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        .dropdown-item:hover {
            background: var(--bg-tertiary);
        }

        .dropdown-item.danger {
            color: var(--accent-danger);
        }

        .dropdown-item.danger:hover {
            background: var(--status-cancelled-bg);
            color: var(--status-cancelled-text);
        }

        /* Legacy table support */
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
            background: var(--bg-secondary);
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            color: var(--text-secondary);
        }

        tbody tr {
            transition: background-color 0.2s ease;
        }

        tbody tr:hover {
            background: var(--bg-tertiary);
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending { background: #fed7aa; color: #c05621; }
        .status-processing { background: #bfdbfe; color: #1e40af; }
        .status-assigned { background: #d9f99d; color: #65a30d; }
        .status-completed { background: #bbf7d0; color: #059669; }
        .status-cancelled { background: #fecaca; color: #dc2626; }

        /* Email Confirmation Badge Styles */
        .email-confirmation-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            min-width: 50px;
        }
        
        .email-confirmation-badge.yes {
            background: #bbf7d0;
            color: #059669;
            border: 1px solid #059669;
        }
        
        .email-confirmation-badge.no {
            background: #f3f4f6;
            color: #6b7280;
            border: 1px solid #d1d5db;
        }

        /* Discount Badge Colors */
        .status-badge.success { background: #bbf7d0; color: #059669; }
        .status-badge.warning { background: #fed7aa; color: #c05621; }
        .status-badge.danger { background: #fecaca; color: #dc2626; }

        /* Pricing Table Specific Styles */
        #pricingTable {
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px var(--shadow);
        }

        #pricingTable th {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            padding: 12px 8px;
            border-bottom: 2px solid var(--border-color);
        }

        #pricingTable td {
            padding: 8px;
            vertical-align: middle;
            font-size: 14px;
        }

        /* Improved table cell alignment */
        #pricingTable td:nth-child(1) { text-align: left; font-weight: 600; }     /* Package */
        #pricingTable td:nth-child(2) { text-align: center; }                    /* Sites */
        #pricingTable td:nth-child(3) { text-align: right; font-family: monospace; } /* Base Price */
        #pricingTable td:nth-child(4) { text-align: right; font-family: monospace; } /* Subscriber Price */
        #pricingTable td:nth-child(5) { text-align: center; font-weight: 600; }  /* Discount */
        #pricingTable td:nth-child(6) { text-align: center; }                    /* Actions */

        /* Pricing Input Fields */
        .pricing-input {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px 6px;
            font-size: 13px;
            font-weight: 500;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
            text-align: right;
            width: 100%;
            max-width: 80px;
            font-family: monospace;
        }

        .pricing-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: #ffffff;
        }

        .pricing-input:hover {
            border-color: var(--accent-primary);
        }

        /* Package Label */
        .package-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        /* Remove Button Styling */
        .remove-package-btn {
            background: var(--accent-danger);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .remove-package-btn:hover {
            background: var(--accent-danger-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(229, 62, 62, 0.2);
        }

        /* Add Package Row */
        .add-package-row {
            background: var(--bg-tertiary);
            border-top: 2px dashed var(--border-color);
        }

        .add-package-btn {
            background: var(--accent-success);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .add-package-btn:hover {
            background: var(--accent-success-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(56, 161, 105, 0.2);
        }

        /* Responsive Table */
        @media (max-width: 768px) {
            .pricing-input {
                width: 60px !important;
                max-width: 60px;
                padding: 4px 6px;
                font-size: 12px;
            }
            
            #pricingTable th,
            #pricingTable td {
                padding: 8px 4px;
                font-size: 12px;
            }
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
            align-items: center;
            min-width: 220px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .action-btn.update {
            background: var(--accent-primary);
            color: white;
        }

        .action-btn.update:hover {
            background: var(--accent-primary-hover);
        }

        .action-btn.delete {
            background: var(--accent-danger);
            color: white;
        }

        .action-btn.delete:hover {
            background: var(--accent-danger-hover);
        }

        .action-btn.edit {
            background: var(--accent-success);
            color: white;
        }

        .action-btn.edit:hover {
            background: var(--accent-success-hover);
        }

        /* Status Select */
        .status-select {
            padding: 6px 8px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            font-size: 12px;
            margin-right: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
            min-width: 100px;
        }

        .status-select:focus {
            outline: none;
            border-color: var(--input-focus);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        /* Success/Error Messages */
        .message {
            padding: 12px 20px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .message.success {
            background: var(--status-completed-bg);
            color: var(--status-completed-text);
            border: 1px solid var(--accent-success);
        }

        .message.error {
            background: var(--status-cancelled-bg);
            color: var(--status-cancelled-text);
            border: 1px solid var(--accent-danger);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--shadow-modal);
        }

        .modal-content {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            margin: 3% auto;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 550px;
            max-height: 85vh;
            overflow: hidden;
            border: none;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 32px 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 16px 16px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 20px;
            font-weight: 600;
        }

        .modal-body {
            padding: 24px 32px 32px;
        }

        .close {
            color: var(--text-secondary);
            font-size: 24px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            background: transparent;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        /* Status selection styles */
        .status-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin: 16px 0 24px 0;
        }

        .status-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 16px 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
            text-align: left;
            min-height: 60px;
        }

        .status-btn:hover {
            border-color: var(--accent-primary);
            background: var(--bg-tertiary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .status-btn.selected {
            border-color: var(--accent-primary);
            background: rgba(102, 126, 234, 0.1);
            color: var(--accent-primary);
        }

        .status-btn .icon {
            font-size: 18px;
            opacity: 0.8;
        }

        .status-btn.selected .icon {
            opacity: 1;
        }

        /* Status-specific colors */
        .status-btn.status-pending:hover,
        .status-btn.status-pending.selected {
            border-color: var(--status-pending-text);
            background: var(--status-pending-bg);
            color: var(--status-pending-text);
        }

        .status-btn.status-processing:hover,
        .status-btn.status-processing.selected {
            border-color: var(--status-processing-text);
            background: var(--status-processing-bg);
            color: var(--status-processing-text);
        }

        .status-btn.status-assigned:hover,
        .status-btn.status-assigned.selected {
            border-color: var(--status-assigned-text);
            background: var(--status-assigned-bg);
            color: var(--status-assigned-text);
        }

        .status-btn.status-completed:hover,
        .status-btn.status-completed.selected {
            border-color: var(--status-completed-text);
            background: var(--status-completed-bg);
            color: var(--status-completed-text);
        }

        .status-btn.status-cancelled:hover,
        .status-btn.status-cancelled.selected {
            border-color: var(--status-cancelled-text);
            background: var(--status-cancelled-bg);
            color: var(--status-cancelled-text);
        }

        /* Form styling improvements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--input-focus);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        /* Modal button styling */
        .modal-body .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            margin-left: 12px;
            transition: all 0.2s ease;
        }

        .modal-body .btn:first-child {
            margin-left: 0;
        }

        .modal-body .btn.success {
            background: var(--accent-success);
            color: white;
            border: none;
        }

        .modal-body .btn.success:hover {
            background: var(--accent-success-hover);
            transform: translateY(-1px);
        }

        /* Current status display */
        .current-status-label {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 16px;
            font-weight: 600;
        }

        .current-status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: capitalize;
        }

        .status-selection-label {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px !important;
        }

        /* Modal action buttons container */
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
        }

        /* Responsive modal */
        @media (max-width: 600px) {
            .modal-content {
                margin: 5% auto;
                width: 95%;
                max-width: none;
            }

            .modal-header,
            .modal-body {
                padding-left: 20px;
                padding-right: 20px;
            }

            .status-buttons {
                grid-template-columns: 1fr;
            }

            .modal-actions {
                flex-direction: column-reverse;
            }

            .modal-body .btn {
                margin-left: 0;
                width: 100%;
            }
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        /* Clickable Table Rows */
        .excel-table tbody tr {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .excel-table tbody tr:hover {
            background-color: var(--bg-tertiary);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px var(--shadow);
        }
        
        .excel-table tbody tr:active {
            transform: translateY(0);
        }
        
        /* Order Details Modal */
        .order-details-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--shadow-modal);
            animation: fadeIn 0.3s ease;
        }
        
        .order-details-content {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            margin: 2% auto;
            padding: 0;
            border-radius: 16px;
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            border: none;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        .order-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 32px 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--gradient-primary);
            color: white;
            border-radius: 16px 16px 0 0;
        }
        
        .order-details-body {
            padding: 24px 32px 32px;
        }
        
        .order-section {
            margin-bottom: 24px;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        
        .order-section h4 {
            margin: 0 0 16px 0;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .order-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .order-info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .order-info-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .order-info-value {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .order-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap;
        }
        
        .order-actions .btn {
            flex: 1;
            min-width: 120px;
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }

        /* Responsive */
        @media (max-width: 1200px) {
            .header-center {
                margin: 0 15px;
            }
            
            .nav-tab {
                padding: 4px 8px;
                font-size: 11px;
                gap: 3px;
            }
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header-center {
                margin: 0 10px;
                overflow-x: auto;
                flex-wrap: nowrap;
                justify-content: flex-start;
            }
            
            .nav-tab {
                padding: 6px 10px;
                font-size: 11px;
                flex-shrink: 0;
            }
            
            .tab-buttons {
                flex-wrap: wrap;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .container {
                padding: 10px;
            }
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            transform: translateX(120%);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.info {
            background-color: #3b82f6;
        }

        .notification.success {
            background-color: #10b981;
        }

        .notification.warning {
            background-color: #f59e0b;
        }

        .notification.error {
            background-color: #ef4444;
        }

        .notification button {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            margin-left: 12px;
        }

        .notification button:hover {
            opacity: 0.8;
        }

        /* Responsive notification adjustments */
        @media (max-width: 768px) {
            .notification {
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div class="login-container" id="loginContainer">
        <div class="login-form">
            <h2>🔐 TeleKpr Admin Login</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username or Email</label>
                    <input type="text" id="username" required placeholder="admin@example.com">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required placeholder="••••••••">
                </div>
                <button type="submit" class="btn" id="loginBtn">Login</button>
                <div class="error-message" id="loginError"></div>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <div class="header">
            <div class="header-top">
                <h1>TeleKpr Admin Dashboard</h1>
                <div class="header-controls">
                    <button class="nav-collapse-btn" onclick="toggleNavCollapse()" id="navCollapseBtn" title="Toggle Navigation">
                        ☰
                    </button>
                    <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">
                        🌙 Dark Mode
                    </button>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>

        <!-- Modern Tab Bar -->
        <div class="tab-bar">
            <div class="tab-container">
                <button class="tab-item active" onclick="switchTab('overview')">
                    <span class="tab-icon">🏠</span>
                    <span class="tab-text">Overview</span>
                </button>
                <button class="tab-item" onclick="switchTab('orders')">
                    <span class="tab-icon">📦</span>
                    <span class="tab-text">Orders</span>
                </button>
                <button class="tab-item" onclick="switchTab('users')">
                    <span class="tab-icon">👥</span>
                    <span class="tab-text">Users</span>
                </button>
                <button class="tab-item" onclick="switchTab('customers')">
                    <span class="tab-icon">🧑‍💼</span>
                    <span class="tab-text">Customers</span>
                </button>
                <button class="tab-item" onclick="switchTab('subscriptions')">
                    <span class="tab-icon">💳</span>
                    <span class="tab-text">Subscriptions</span>
                </button>
                <button class="tab-item" onclick="switchTab('pricing')">
                    <span class="tab-icon">💰</span>
                    <span class="tab-text">Pricing</span>
                </button>
                <button class="tab-item" onclick="switchTab('settings')">
                    <span class="tab-icon">⚙️</span>
                    <span class="tab-text">Settings</span>
                </button>
                <button class="tab-item" onclick="switchTab('broadcast')">
                    <span class="tab-icon">📢</span>
                    <span class="tab-text">Broadcast</span>
                </button>
            </div>
        </div>

        <div class="main-container">
            <!-- Messages -->
            <div class="message success" id="successMessage"></div>
            <div class="message error" id="errorMessage"></div>

            <!-- Content Area -->
                    <!-- Overview Tab -->
                    <div class="tab-pane active" id="overviewTab">
                        <!-- Stats -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>Total Users</h3>
                                <div class="value" id="statUsers">0</div>
                                <div class="trend up" id="usersTrend">+0%</div>
                            </div>
                            <div class="stat-card">
                                <h3>Total Orders</h3>
                                <div class="value" id="statOrders">0</div>
                                <div class="trend up" id="ordersTrend">+0%</div>
                            </div>
                            <div class="stat-card">
                                <h3>Pending Orders</h3>
                                <div class="value" id="statPending">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Total Revenue</h3>
                                <div class="value" id="statRevenue">0</div>
                                <div class="trend up" id="revenueTrend">+0%</div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Analytics Section -->
                        <div style="margin: 30px 0;">
                            <h2 style="margin-bottom: 20px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                                <span>📊</span> Business Analytics
                            </h2>
                            
                            <!-- Enhanced KPI Cards -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <h4 style="margin: 0; font-size: 14px; opacity: 0.9;">Total Revenue</h4>
                                            <div style="font-size: 24px; font-weight: bold; margin: 8px 0;" id="overviewRevenue">$0</div>
                                            <div style="font-size: 12px; opacity: 0.8;" id="overviewRevenueChange">+0% from last period</div>
                                        </div>
                                        <div style="font-size: 32px; opacity: 0.7;">💰</div>
                                    </div>
                                </div>
                                
                                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <h4 style="margin: 0; font-size: 14px; opacity: 0.9;">Completion Rate</h4>
                                            <div style="font-size: 24px; font-weight: bold; margin: 8px 0;" id="overviewCompletionRate">0%</div>
                                            <div style="font-size: 12px; opacity: 0.8;" id="overviewCompletionChange">+0% efficiency</div>
                                        </div>
                                        <div style="font-size: 32px; opacity: 0.7;">✅</div>
                                    </div>
                                </div>
                                
                                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <h4 style="margin: 0; font-size: 14px; opacity: 0.9;">Avg Order Value</h4>
                                            <div style="font-size: 24px; font-weight: bold; margin: 8px 0;" id="overviewAvgOrder">0</div>
                                            <div style="font-size: 12px; opacity: 0.8;" id="overviewAvgOrderChange">tokens per order</div>
                                        </div>
                                        <div style="font-size: 32px; opacity: 0.7;">📈</div>
                                    </div>
                                </div>
                                
                                <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <h4 style="margin: 0; font-size: 14px; opacity: 0.9;">Active Subscribers</h4>
                                            <div style="font-size: 24px; font-weight: bold; margin: 8px 0;" id="overviewSubscribers">0</div>
                                            <div style="font-size: 12px; opacity: 0.8;" id="overviewSubscriberRate">0% conversion rate</div>
                                        </div>
                                        <div style="font-size: 32px; opacity: 0.7;">👥</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Charts Section -->
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-bottom: 30px;">
                                <!-- Order Status Distribution -->
                                <div class="stat-card">
                                    <h3 style="margin: 0 0 20px 0; display: flex; align-items: center; gap: 8px;">
                                        <span>🎯</span> Order Status Distribution
                                    </h3>
                                    <div class="chart-container" style="height: 250px;">
                                        <canvas id="overviewStatusChart"></canvas>
                                    </div>
                                </div>
                                
                                <!-- Quick Actions -->
                                <div class="stat-card">
                                    <h3>🎯 Quick Actions</h3>
                                    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                                        <button class="btn" onclick="switchTab('orders')">📦 View Orders</button>
                                        <button class="btn" onclick="switchTab('users')">👥 Manage Users</button>
                                        <button class="btn" onclick="switchTab('broadcast')">📢 Send Broadcast</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                <div class="stat-card">
                                    <h3>📊 System Health</h3>
                                    <div style="margin-top: 15px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                            <span>Bot Status:</span>
                                            <span style="color: var(--accent-success);">✅ Online</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                            <span>Database:</span>
                                            <span style="color: var(--accent-success);">✅ Connected</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Payments:</span>
                                            <span style="color: var(--accent-success);">✅ Monitoring</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="stat-card">
                                    <h3>💡 System Info</h3>
                                    <div style="margin-top: 15px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                            <span>Total Revenue:</span>
                                            <span style="color: var(--accent-primary); font-weight: bold;">$<span id="overviewTotalRevenue">0</span></span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                            <span>This Month:</span>
                                            <span style="color: var(--accent-success);">$<span id="overviewMonthRevenue">0</span></span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Last Updated:</span>
                                            <span style="color: var(--text-secondary); font-size: 12px;" id="overviewLastUpdated">Just now</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Orders Tab -->
                    <div class="tab-pane" id="ordersTab">
                        <div class="loading" id="ordersLoading" style="padding: 20px;">Loading orders...</div>
                        <div class="excel-table-container" id="ordersTableContainer" style="display: none;">
                            <table id="ordersTable" class="excel-table">
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Who Ordered</th>
                                        <th>Customer</th>
                                        <th>Package</th>
                                        <th>Tokens</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Users Tab -->
                    <div class="tab-pane" id="usersTab">
                        <div style="margin-bottom: 20px; padding: 20px; display: flex; gap: 15px; align-items: center;">
                            <div class="form-group" style="margin: 0; flex: 1; max-width: 400px;">
                                <label for="userSearch" style="margin-bottom: 8px;">🔍 Search Users:</label>
                                <input type="text" id="userSearch" placeholder="Search by Telegram ID, username, or full name..." 
                                       onkeyup="searchUsers()" style="width: 100%;">
                            </div>
                            <button class="btn btn-secondary" onclick="clearUserSearch()">Clear</button>
                            <button class="btn" onclick="loadUsers()">🔄 Refresh</button>
                        </div>
                        <div class="loading" id="usersLoading" style="padding: 20px;">Loading users...</div>
                        <div class="excel-table-container" id="usersTableContainer" style="display: none;">
                            <table id="usersTable" class="excel-table">
                                <thead>
                                    <tr>
                                        <th>Telegram ID</th>
                                        <th>Username</th>
                                        <th>Full Name</th>
                                        <th>Token Balance</th>
                                        <th>Admin</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Customers Tab -->
                    <div class="tab-pane" id="customersTab">
                        <div style="margin-bottom: 20px; padding: 20px;">
                            <button class="btn" onclick="exportCustomers()">📊 Export CSV</button>
                        </div>
                        <div class="loading" id="customersLoading" style="padding: 20px;">Loading customers...</div>
                        <div class="excel-table-container" id="customersTableContainer" style="display: none;">
                            <table id="customersTable" class="excel-table">
                                <thead>
                                    <tr>
                                        <th>Customer ID</th>
                                        <th>First Name</th>
                                        <th>Middle</th>
                                        <th>Last Name</th>
                                        <th>Phone</th>
                                        <th>Email</th>
                                        <th>Password</th>
                                        <th>Address</th>
                                        <th>City</th>
                                        <th>State</th>
                                        <th>Postal Code</th>
                                        <th>Gender</th>
                                        <th>DOB</th>
                                        <th>Registered</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="customersTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Subscriptions Tab -->
                    <div class="tab-pane" id="subscriptionsTab">
                        <div class="loading" id="subscriptionsLoading" style="padding: 20px;">Loading subscriptions...</div>
                        <div class="excel-table-container" id="subscriptionsTableContainer" style="display: none;">
                            <table id="subscriptionsTable" class="excel-table">
                                <thead>
                                    <tr>
                                        <th>Subscription ID</th>
                                        <th>User</th>
                                        <th>Telegram</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Expires</th>
                                        <th>Days Remaining</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="subscriptionsTableBody"></tbody>
                            </table>
                        </div>
                    </div>


                    <!-- Settings Tab -->
                    <!-- Pricing Tab -->
                    <div class="tab-pane" id="pricingTab">
                        <!-- Two Column Layout for Pricing -->
                        <div style="display: grid; grid-template-columns: 1fr 350px; gap: 30px; height: calc(100vh - 200px);">
                            
                            <!-- Left Column: Package Pricing Table -->
                            <div style="display: flex; flex-direction: column;">
                                <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                                    <h3>📦 Package Pricing Management</h3>
                                    <div>
                                        <button class="btn success" onclick="savePricing()">💾 Save Changes</button>
                                        <button class="btn" onclick="loadPricing()">🔄 Reload</button>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info" style="margin-bottom: 20px; padding: 15px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px;">
                                    <strong>ℹ️ Pricing System:</strong> Non-subscribers pay the base price, while subscribers receive discounted pricing. Email confirmation pricing applies equally to both user types.
                                </div>
                                
                                <div class="alert alert-warning" id="pricingWarning" style="display: none; margin-bottom: 20px;">
                                    <strong>⚠️ Important:</strong> Changes to pricing require a bot restart to take effect.
                                </div>
                                
                                <div class="table-container" style="flex: 1; overflow: auto; border-radius: 12px; box-shadow: 0 4px 12px var(--shadow);">
                                    <div class="loading" id="pricingLoading" style="padding: 40px; text-align: center; color: var(--text-secondary);">
                                        <div style="font-size: 16px; margin-bottom: 8px;">📊</div>
                                        Loading pricing data...
                                    </div>
                                    
                                    <table id="pricingTable" style="display: none; width: 100%; table-layout: fixed;">
                                        <thead>
                                            <tr>
                                                <th style="width: 12%; text-align: left;">Package</th>
                                                <th style="width: 12%; text-align: center;">Sites</th>
                                                <th style="width: 16%; text-align: right;">Base Price</th>
                                                <th style="width: 16%; text-align: right;">Subscriber Price</th>
                                                <th style="width: 12%; text-align: center;">Discount</th>
                                                <th style="width: 32%; text-align: center;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="pricingTableBody">
                                            <!-- Pricing rows will be populated here -->
                                        </tbody>
                                    </table>
                                    
                                    <div id="pricingError" style="display: none; text-align: center; padding: 40px;">
                                        <div style="color: var(--accent-danger); font-size: 24px; margin-bottom: 8px;">⚠️</div>
                                        <div style="color: var(--accent-danger); font-weight: 600;">Error loading pricing data</div>
                                        <div style="color: var(--text-tertiary); font-size: 14px; margin-top: 8px;">Please try refreshing the page</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right Column: Email Confirmation Pricing -->
                            <div style="display: flex; flex-direction: column; gap: 20px;">
                                <div class="stat-card" style="height: fit-content;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                                        <span style="font-size: 24px;">📧</span>
                                        <h3 style="margin: 0; color: var(--text-primary);">Email Confirmation</h3>
                                    </div>
                                    
                                    <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--accent-primary);">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                            <span style="font-weight: 600; color: var(--text-secondary);">Regular Users</span>
                                            <span style="font-size: 20px; font-weight: bold; color: var(--accent-primary);"><span id="emailConfirmationPriceRegular">350</span> tokens</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                            <span style="font-weight: 600; color: var(--text-secondary);">Subscribers</span>
                                            <span style="font-size: 20px; font-weight: bold; color: var(--accent-success);"><span id="emailConfirmationPriceSubscriber">30</span> tokens</span>
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-tertiary);">
                                            Per order addon service - subscribers get discounted rate
                                        </div>
                                    </div>
                                    
                                    <div class="form-group" style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Update Prices</label>
                                        <div style="display: flex; flex-direction: column; gap: 10px;">
                                            <div style="display: flex; gap: 10px; align-items: center;">
                                                <span style="min-width: 80px; font-size: 12px; color: var(--text-secondary);">Regular:</span>
                                                <input type="number" id="newEmailPriceRegular" min="1" placeholder="350" 
                                                       style="flex: 1; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--input-bg);">
                                            </div>
                                            <div style="display: flex; gap: 10px; align-items: center;">
                                                <span style="min-width: 80px; font-size: 12px; color: var(--text-secondary);">Subscriber:</span>
                                                <input type="number" id="newEmailPriceSubscriber" min="1" placeholder="30" 
                                                       style="flex: 1; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--input-bg);">
                                            </div>
                                            <button class="btn" onclick="updateEmailConfirmationPrice()" style="align-self: flex-start;">Update Prices</button>
                                        </div>
                                    </div>
                                    
                                    <div style="padding: 15px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                                        <h4 style="margin: 0 0 10px 0; font-size: 14px; color: var(--text-primary);">📋 Service Details</h4>
                                        <ul style="margin: 0; padding-left: 16px; font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                                            <li>Optional addon during order checkout</li>
                                            <li>Available for all users (subscribers & non-subscribers)</li>
                                            <li>Provides email confirmation service</li>
                                            <li>Added to base package price</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <!-- Pricing Statistics Card -->
                                <div class="stat-card" style="height: fit-content;">
                                    <h4 style="margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                                        <span>📊</span> Pricing Stats
                                    </h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 12px;">
                                        <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 6px;">
                                            <div style="font-weight: bold; color: var(--accent-primary); font-size: 16px;" id="totalPackages">8</div>
                                            <div style="color: var(--text-tertiary);">Total Packages</div>
                                        </div>
                                        <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 6px;">
                                            <div style="font-weight: bold; color: var(--accent-success); font-size: 16px;" id="avgDiscount">40%</div>
                                            <div style="color: var(--text-tertiary);">Avg Discount</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Transactions Section -->
                        <div style="margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 30px;">
                            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                                    <span>💰</span> Token Transactions
                                </h3>
                                <button class="btn" onclick="loadTransactions()">🔄 Refresh</button>
                            </div>
                            <div class="loading" id="transactionsLoading" style="padding: 20px;">Loading transactions...</div>
                            <div class="excel-table-container" id="transactionsTableContainer" style="display: none;">
                                <table id="transactionsTable" class="excel-table">
                                    <thead>
                                        <tr>
                                            <th>Transaction ID</th>
                                            <th>Date/Time</th>
                                            <th>User</th>
                                            <th>Type</th>
                                            <th>Amount</th>
                                            <th>Balance After</th>
                                            <th>Payment Method</th>
                                            <th>Status</th>
                                            <th>Payment ID</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactionsTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Broadcast Tab -->
                    <div class="tab-pane" id="broadcastTab">
                        <div class="section">
                            <h2>📢 Broadcast Message</h2>
                            <div class="broadcast-container">
                                <div class="form-container">
                                    <div class="form-group">
                                        <label for="broadcastTitle">Message Title</label>
                                        <input type="text" id="broadcastTitle" placeholder="Enter message title..." maxlength="100">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="broadcastMessage">Message Content</label>
                                        <textarea id="broadcastMessage" rows="6" placeholder="Enter your message..." maxlength="3900"></textarea>
                                        <small class="form-help">
                                            <span id="charCount">0</span> / 3900 characters
                                        </small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="broadcastEmoji">Emoji (Optional)</label>
                                        <select id="broadcastEmoji">
                                            <option value="📢">📢 Announcement</option>
                                            <option value="🎉">🎉 Celebration</option>
                                            <option value="⚠️">⚠️ Warning</option>
                                            <option value="ℹ️">ℹ️ Information</option>
                                            <option value="🚀">🚀 Update</option>
                                            <option value="💡">💡 Tip</option>
                                            <option value="🎁">🎁 Offer</option>
                                            <option value="🔧">🔧 Maintenance</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="broadcastTestMode" checked>
                                            <strong>Test Mode</strong> - Send to admins only
                                        </label>
                                        <small class="form-help">Uncheck to send to ALL users or select specific users</small>
                                    </div>

                                    <!-- User Selection Section -->
                                    <div class="form-group" id="userSelectionSection" style="display: none;">
                                        <div class="section-header">
                                            <label><strong>👥 Select Recipients</strong></label>
                                            
                                            <!-- Search Input -->
                                            <div style="margin: 8px 0;">
                                                <input type="text" 
                                                       id="userSearchInput" 
                                                       placeholder="🔍 Search by name, username, or Telegram ID..." 
                                                       style="width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;"
                                                       oninput="filterUsers(this.value)">
                                            </div>
                                            
                                            <div style="display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap;">
                                                <button type="button" class="btn btn-sm secondary" onclick="selectAllUsers()">
                                                    ✅ Select All
                                                </button>
                                                <button type="button" class="btn btn-sm secondary" onclick="deselectAllUsers()">
                                                    ❌ Deselect All
                                                </button>
                                                <button type="button" class="btn btn-sm secondary" onclick="selectAdminsOnly()">
                                                    👑 Admins Only
                                                </button>
                                                <button type="button" class="btn btn-sm secondary" onclick="selectFilteredUsers()">
                                                    ✨ Select Filtered
                                                </button>
                                                <button type="button" class="btn btn-sm secondary" onclick="selectPageUsers()">
                                                    📄 Select Page
                                                </button>
                                                <button type="button" class="btn btn-sm secondary" onclick="clearSearch()">
                                                    🗑️ Clear
                                                </button>
                                                <button type="button" class="btn btn-sm secondary" onclick="refreshUserList()">
                                                    🔄 Refresh
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div id="userSelectionLoader" style="text-align: center; padding: 20px; display: none;">
                                            <div class="spinner"></div>
                                            <p>Loading users...</p>
                                        </div>
                                        
                                        <div id="userSelectionStats" style="padding: 10px; background: var(--bg-secondary); border-radius: 6px; margin: 10px 0; font-size: 0.9em; color: var(--text-secondary); border: 1px solid var(--border-color);">
                                            <span id="selectedCount">0</span> of <span id="visibleUsers">0</span> users selected
                                            (<span id="adminCount">0</span> admins, <span id="regularCount">0</span> regular users)
                                            <span id="filterStats" style="display: none;"> | Showing <span id="filteredCount">0</span> of <span id="totalUsers">0</span> total users</span>
                                        </div>
                                        
                                        <!-- Pagination Controls -->
                                        <div id="paginationControls" style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 10px; background: var(--bg-secondary); border-radius: 6px; border: 1px solid var(--border-color);">
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <button type="button" class="btn btn-sm secondary" id="prevPageBtn" onclick="changePage(-1)" disabled>
                                                    ← Previous
                                                </button>
                                                <span id="pageInfo" style="font-size: 0.9em; color: var(--text-secondary);">
                                                    Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                                                </span>
                                                <button type="button" class="btn btn-sm secondary" id="nextPageBtn" onclick="changePage(1)" disabled>
                                                    Next →
                                                </button>
                                            </div>
                                            <div style="font-size: 0.85em; color: var(--text-muted);">
                                                Showing <span id="pageRangeStart">0</span>-<span id="pageRangeEnd">0</span> of <span id="totalUsersCount">0</span> users
                                            </div>
                                        </div>
                                        
                                        <div class="excel-table-container" id="userSelectionContainer" style="max-height: 400px; overflow-y: auto; margin-top: 10px; display: none;">
                                            <table id="userSelectionTable" class="excel-table">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 40px;">
                                                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllUsers(this)" title="Select/Deselect All">
                                                        </th>
                                                        <th>Name</th>
                                                        <th>Username</th>
                                                        <th>Telegram ID</th>
                                                        <th style="width: 80px;">Role</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="userSelectionTableBody">
                                                    <!-- User rows will be populated here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- Batch Broadcasting Options -->
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="batchModeEnabled">
                                            <strong>📦 Batch Mode</strong> - Send in groups of 100 users
                                        </label>
                                        <small class="form-help">Recommended for large broadcasts (200+ users). Reduces server load and provides better progress tracking.</small>
                                    </div>

                                    <div class="button-group">
                                        <button class="btn primary" onclick="previewBroadcast()">
                                            👁️ Preview
                                        </button>
                                        <button class="btn success" onclick="sendBroadcast()">
                                            📤 Send Message
                                        </button>
                                        <button class="btn success" id="sendBatchBtn" onclick="sendBatchBroadcast()" style="display: none;">
                                            📦 Send in Batches
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="preview-container" id="broadcastPreview" style="display: none;">
                                    <h3>Message Preview</h3>
                                    <div class="preview-box" id="previewContent">
                                        <!-- Preview will be shown here -->
                                    </div>
                                </div>
                                
                                <div class="result-container" id="broadcastResult" style="display: none; margin-top: 20px;">
                                    <!-- Results will be shown here -->
                                </div>
                                
                                <!-- Live Delivery Logs -->
                                <div class="result-container" id="broadcastLogs" style="display: none; margin-top: 20px;">
                                    <h4>📋 Live Delivery Logs</h4>
                                    <div id="deliveryLogs" style="background: var(--bg-primary); padding: 15px; border-radius: 6px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 13px; border: 1px solid var(--border-color);">
                                        <div class="log-entry" style="color: var(--text-secondary);">Waiting for broadcast to start...</div>
                                    </div>
                                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                                        <button class="btn btn-sm secondary" onclick="clearDeliveryLogs()">🗑️ Clear Logs</button>
                                        <button class="btn btn-sm secondary" onclick="toggleAutoScroll()" id="autoScrollBtn">📜 Auto-scroll: ON</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane" id="settingsTab">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>System Information</h3>
                                <p><strong>Version:</strong> TeleKpr v1.0</p>
                                <p><strong>Status:</strong> <span style="color: green;">✅ Online</span></p>
                                <p><strong>Last Updated:</strong> <span id="lastUpdated">Just now</span></p>
                            </div>
                            <div class="stat-card">
                                <h3>Bot Management</h3>
                                <div id="botStatusInfo" style="margin-bottom: 15px;">
                                    <p><strong>Bot Status:</strong> <span id="botStatus">Checking...</span></p>
                                    <p><strong>Uptime:</strong> <span id="botUptime">-</span></p>
                                    <p><strong>Restarts:</strong> <span id="botRestarts">-</span></p>
                                    <p><strong>Memory:</strong> <span id="botMemory">-</span></p>
                                </div>
                                <button class="btn danger mb-10" onclick="restartBot()" id="restartBotBtn">🔄 Restart Bot</button><br>
                                <button class="btn mb-10" onclick="checkBotStatus()">📊 Check Status</button>
                            </div>
                            <div class="stat-card">
                                <h3>Payment Monitoring</h3>
                                <div id="paymentMonitorInfo" style="margin-bottom: 15px;">
                                    <p><strong>Fallback System:</strong> <span id="fallbackStatus">Checking...</span></p>
                                    <p><strong>Stuck Payments:</strong> <span id="stuckPayments">-</span></p>
                                    <p><strong>Last Hour - Pending:</strong> <span id="recentPending">-</span></p>
                                    <p><strong>Last Hour - Completed:</strong> <span id="recentCompleted">-</span></p>
                                    <p><strong>Last Check:</strong> <span id="lastPaymentCheck">-</span></p>
                                </div>
                                <button class="btn mb-10" onclick="checkPaymentStatus()">🔍 Check Payments</button><br>
                                <div style="padding: 10px; background: var(--bg-tertiary); border-radius: 6px; border-left: 4px solid var(--accent-success);">
                                    <small style="color: var(--text-secondary);">✅ Secure payment processing now available in <strong>Payment Review</strong> tab</small>
                                </div>
                            </div>
                            <div class="stat-card">
                                <h3>Quick Actions</h3>
                                <button class="btn mb-10" onclick="refreshAll()">🔄 Refresh All Data</button><br>
                                <button class="btn mb-10" onclick="exportCustomers()">📊 Export Customers</button><br>
                                <button class="btn mb-10" onclick="showSystemLogs()">📜 View System Logs</button>
                            </div>
                        </div>
                    </div>
                    </div>
            </div>
        </div>
    </div>

    <!-- Payment Approval Modal -->
    <div id="paymentApprovalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🔒 Approve Payment</h3>
                <span class="close" onclick="closeModal('paymentApprovalModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="paymentApprovalDetails" style="margin-bottom: 20px;">
                    <!-- Payment details will be populated here -->
                </div>
                <div class="form-group">
                    <label for="adminNote">Admin Note (optional)</label>
                    <textarea id="adminNote" rows="3" placeholder="Reason for approval, verification notes, etc."></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn" onclick="closeModal('paymentApprovalModal')">Cancel</button>
                    <button class="btn btn-danger" onclick="confirmPaymentApproval()" id="approvePaymentBtn">🔓 Approve Payment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Token Management Modal -->
    <div id="tokenModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage User Tokens</h3>
                <span class="close" onclick="closeModal('tokenModal')">&times;</span>
            </div>
            <form id="tokenForm">
                <input type="hidden" id="tokenUserId">
                <div class="form-group">
                    <label>User: <span id="tokenUserName"></span></label>
                    <label>Current Balance: <span id="tokenCurrentBalance"></span> tokens</label>
                </div>
                <div class="form-group">
                    <label for="tokenAmount">Amount (use negative for deduction)</label>
                    <input type="number" id="tokenAmount" required placeholder="100 or -50">
                </div>
                <div class="form-group">
                    <label for="tokenDescription">Description</label>
                    <input type="text" id="tokenDescription" required placeholder="Bonus tokens, refund, etc.">
                </div>
                <div style="text-align: right;">
                    <button type="button" class="btn" onclick="closeModal('tokenModal')">Cancel</button>
                    <button type="submit" class="btn success">Update Tokens</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customer Edit Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Customer</h3>
                <span class="close" onclick="closeModal('customerModal')">&times;</span>
            </div>
            <form id="customerForm">
                <input type="hidden" id="customerId">
                <div class="form-group">
                    <label for="customerFirstName">First Name</label>
                    <input type="text" id="customerFirstName" required>
                </div>
                <div class="form-group">
                    <label for="customerLastName">Last Name</label>
                    <input type="text" id="customerLastName" required>
                </div>
                <div class="form-group">
                    <label for="customerPhone">Phone</label>
                    <input type="tel" id="customerPhone">
                </div>
                <div class="form-group">
                    <label for="customerEmail">Email</label>
                    <input type="email" id="customerEmail">
                </div>
                <div class="form-group">
                    <label for="customerPassword">Password</label>
                    <input type="text" id="customerPassword" placeholder="Password for email services">
                </div>
                <div class="form-group">
                    <label for="customerAddress">Address</label>
                    <textarea id="customerAddress" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="customerCity">City</label>
                    <input type="text" id="customerCity">
                </div>
                <div class="form-group">
                    <label for="customerState">State</label>
                    <input type="text" id="customerState">
                </div>
                <div class="form-group">
                    <label for="customerPostalCode">Postal Code</label>
                    <input type="text" id="customerPostalCode">
                </div>
                <div style="text-align: right;">
                    <button type="button" class="btn" onclick="closeModal('customerModal')">Cancel</button>
                    <button type="submit" class="btn success">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Status Modal -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Order Status</h3>
                <span class="close" onclick="closeModal('statusModal')">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="statusOrderId">
                <input type="hidden" id="statusTelegramId">
                <div class="form-group">
                    <label class="current-status-label">
                        Current Status: 
                        <span id="currentStatusDisplay" class="current-status-badge"></span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="status-selection-label">Select New Status:</label>
                    <div class="status-buttons">
                        <button class="status-btn status-pending" data-status="pending">
                            <span class="icon">⏳</span>
                            Pending
                        </button>
                        <button class="status-btn status-processing" data-status="processing">
                            <span class="icon">⚙️</span>
                            Processing
                        </button>
                        <button class="status-btn status-assigned" data-status="assigned">
                            <span class="icon">👤</span>
                            Assigned
                        </button>
                        <button class="status-btn status-completed" data-status="completed">
                            <span class="icon">✅</span>
                            Completed
                        </button>
                        <button class="status-btn status-cancelled" data-status="cancelled">
                            <span class="icon">❌</span>
                            Cancelled
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="statusNotes">Notes (optional):</label>
                    <textarea id="statusNotes" rows="3" placeholder="Add any notes about this status change..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" onclick="closeModal('statusModal')">Cancel</button>
                    <button type="button" class="btn success" id="updateStatusBtn" onclick="confirmStatusUpdate()">Update Status</button>
                </div>
            </div>
        </div>
    </div>

    <!-- System Logs Modal -->
    <div id="logsModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; width: 95%; max-height: 90vh;">
            <div class="modal-header">
                <h3>📜 System Logs</h3>
                <span class="close" onclick="closeModal('logsModal')">&times;</span>
            </div>
            
            <!-- Log Controls -->
            <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);">
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <div class="form-group" style="margin: 0; min-width: 200px;">
                        <label for="logFileSelect">Log File:</label>
                        <select id="logFileSelect" onchange="loadSelectedLog()" style="width: 100%;">
                            <option value="">Select a log file...</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0; min-width: 200px;">
                        <label for="logSearch">Search:</label>
                        <input type="text" id="logSearch" placeholder="Search logs..." onkeyup="searchLogs()">
                    </div>
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <button class="btn btn-secondary" onclick="refreshLogs()">🔄 Refresh</button>
                        <button class="btn btn-secondary" onclick="downloadCurrentLog()" id="downloadBtn" disabled>⬇️ Download</button>
                        <button class="btn btn-secondary" onclick="toggleAutoRefresh()" id="autoRefreshBtn">▶️ Auto Refresh</button>
                    </div>
                </div>
                <div style="margin-top: 10px; display: flex; gap: 15px; align-items: center; font-size: 14px; color: var(--text-secondary);">
                    <span id="logFileInfo">No file selected</span>
                    <span id="logStats"></span>
                </div>
            </div>
            
            <!-- Log Content -->
            <div style="background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; height: 500px; overflow: hidden; position: relative;">
                <div id="logLoading" class="loading" style="display: none;">Loading logs...</div>
                <div id="logContent" style="height: 100%; overflow-y: auto; padding: 15px; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.4; background: var(--bg-primary); color: var(--text-primary);">
                    <div style="text-align: center; color: var(--text-secondary); padding: 50px;">
                        Select a log file to view its contents
                    </div>
                </div>
                <div id="logScrollToBottom" style="position: absolute; bottom: 10px; right: 10px; display: none;">
                    <button class="btn btn-secondary" onclick="scrollToBottom()" style="padding: 5px 10px; font-size: 12px;">↓ Bottom</button>
                </div>
            </div>
            
            <!-- Log Pagination -->
            <div id="logPagination" style="margin-top: 15px; display: none; justify-content: space-between; align-items: center;">
                <div>
                    <button class="btn btn-secondary" onclick="loadPreviousPage()" id="prevPageBtn" disabled>← Previous</button>
                    <span id="pageInfo" style="margin: 0 15px; color: var(--text-secondary);"></span>
                    <button class="btn btn-secondary" onclick="loadNextPage()" id="nextPageBtn" disabled>Next →</button>
                </div>
                <div style="color: var(--text-secondary); font-size: 14px;">
                    <span id="totalLinesInfo"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderDetailsModal" class="order-details-modal">
        <div class="order-details-content">
            <div class="order-details-header">
                <h3 id="orderDetailsTitle">Order Details</h3>
                <span class="close" onclick="closeOrderDetailsModal()">&times;</span>
            </div>
            <div class="order-details-body">
                <!-- User Information Section -->
                <div class="order-section">
                    <h4>👤 Who Ordered</h4>
                    <div class="order-info-grid">
                        <div class="order-info-item">
                            <div class="order-info-label">Telegram Username</div>
                            <div class="order-info-value" id="orderUserUsername">-</div>
                        </div>
                        <div class="order-info-item">
                            <div class="order-info-label">Telegram ID</div>
                            <div class="order-info-value" id="orderUserTelegramId">-</div>
                        </div>
                        <div class="order-info-item">
                            <div class="order-info-label">Full Name</div>
                            <div class="order-info-value" id="orderUserFullName">-</div>
                        </div>
                    </div>
                </div>

                <!-- Customer Information Section -->
                <div class="order-section">
                    <h4>📋 Customer Details</h4>
                    <div class="order-info-grid">
                        <div class="order-info-item">
                            <div class="order-info-label">Name</div>
                            <div class="order-info-value" id="orderCustomerName">-</div>
                        </div>
                        <div class="order-info-item">
                            <div class="order-info-label">Email</div>
                            <div class="order-info-value" id="orderCustomerEmail">-</div>
                        </div>
                        <div class="order-info-item">
                            <div class="order-info-label">Phone</div>
                            <div class="order-info-value" id="orderCustomerPhone">-</div>
                        </div>
                        <div class="order-info-item">
                            <div class="order-info-label">Address</div>
                            <div class="order-info-value" id="orderCustomerAddress">-</div>
                        </div>
                        <div class="order-info-item">
                            <div class="order-info-label">City, State</div>
                            <div class="order-info-value" id="orderCustomerLocation">-</div>
                        </div>
                        <div class="order-info-item">
                            <div class="order-info-label">Postal Code</div>
                            <div class="order-info-value" id="orderCustomerPostal">-</div>
                        </div>
                        <div class="order-info-item">
                            <div class="order-info-label">Gender</div>
                            <div class="order-info-value" id="orderCustomerGender">-</div>
                        </div>
                        <div class="order-info-item">
                            <div class="order-info-label">Date of Birth</div>
                            <div class="order-info-value" id="orderCustomerDob">-</div>
                        </div>
                        <div class="order-info-item">
                            <div class="order-info-label">Password</div>
                            <div class="order-info-value" id="orderCustomerPassword">-</div>
                        </div>
                    </div>
                </div>

                <!-- Order Information Section -->
                <div class="order-section">
                    <h4>📦 Order Information</h4>
                    <div class="order-info-grid">
                        <div class="order-info-item">
                            <div class="order-info-label">Order ID</div>
                            <div class="order-info-value" id="orderOrderId">-</div>
                        </div>
                        <div class="order-info-item">
                            <div class="order-info-label">Package</div>
                            <div class="order-info-value" id="orderPackage">-</div>
                        </div>
                        <div class="order-info-item">
                            <div class="order-info-label">Email Confirmation</div>
                            <div class="order-info-value" id="orderEmailConfirmation">-</div>
                        </div>
                        <div class="order-info-item">
                            <div class="order-info-label">Token Cost</div>
                            <div class="order-info-value" id="orderTokenCost">-</div>
                        </div>
                        <div class="order-info-item">
                            <div class="order-info-label">Status</div>
                            <div class="order-info-value" id="orderStatus">-</div>
                        </div>
                        <div class="order-info-item">
                            <div class="order-info-label">Created</div>
                            <div class="order-info-value" id="orderCreated">-</div>
                        </div>
                        <div class="order-info-item">
                            <div class="order-info-label">Notes</div>
                            <div class="order-info-value" id="orderNotes">-</div>
                        </div>
                    </div>
                </div>

                <!-- Actions Section -->
                <div class="order-actions">
                    <button class="btn btn-primary" onclick="editOrderStatus()">📝 Update Status</button>
                    <button class="btn btn-secondary" onclick="contactUser()">💬 Contact User</button>
                    <button class="btn btn-danger" onclick="deleteOrderFromModal()">🗑️ Delete Order</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE = window.location.origin;
        let authToken = localStorage.getItem('adminToken');
        let currentData = { users: [], orders: [], customers: [] };

        // Check if already logged in
        if (authToken) {
            showDashboard();
        }

        // Login Form Handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';
            loginError.textContent = '';
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    authToken = data.token;
                    localStorage.setItem('adminToken', authToken);
                    showDashboard();
                } else {
                    loginError.textContent = data.error || 'Login failed. Please try again.';
                }
            } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = 'Network error. Please try again.';
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login';
            }
        });

        // Show Dashboard
        function showDashboard() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadStats();
            loadEmailConfirmationPrice();
            updateLastUpdated();
            // Start with overview tab active
            switchTab('overview');
        }

        // Logout
        function logout() {
            localStorage.removeItem('adminToken');
            window.location.reload();
        }

        // API Request Helper
        async function apiRequest(endpoint, options = {}) {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            
            if (response.status === 401) {
                logout();
                throw new Error('Session expired');
            }
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Server error (${response.status}): ${errorText || 'Unknown error'}`);
            }
            
            return response;
        }

        // Load Stats
        async function loadStats() {
            try {
                const response = await apiRequest('/api/admin/stats');
                const stats = await response.json();
                
                // Update basic stats cards
                document.getElementById('statUsers').textContent = stats.totalUsers || 0;
                document.getElementById('statOrders').textContent = stats.totalOrders || 0;
                document.getElementById('statPending').textContent = stats.pendingOrders || 0;
                document.getElementById('statRevenue').textContent = stats.totalRevenue || 0;
                
                // Update overview analytics elements
                const overviewRevenue = document.getElementById('overviewRevenue');
                const overviewCompletionRate = document.getElementById('overviewCompletionRate');
                const overviewAvgOrder = document.getElementById('overviewAvgOrder');
                const overviewSubscribers = document.getElementById('overviewSubscribers');
                const overviewTotalRevenue = document.getElementById('overviewTotalRevenue');
                const overviewMonthRevenue = document.getElementById('overviewMonthRevenue');
                const overviewLastUpdated = document.getElementById('overviewLastUpdated');
                
                if (overviewRevenue) overviewRevenue.textContent = `$${stats.totalRevenue || 0}`;
                if (overviewCompletionRate) overviewCompletionRate.textContent = `${stats.completionRate || 0}%`;
                if (overviewAvgOrder) overviewAvgOrder.textContent = stats.avgOrderValue || 0;
                if (overviewSubscribers) overviewSubscribers.textContent = stats.activeSubscribers || 0;
                if (overviewTotalRevenue) overviewTotalRevenue.textContent = stats.totalRevenue || 0;
                if (overviewMonthRevenue) overviewMonthRevenue.textContent = stats.currentMonthRevenue || 0;
                if (overviewLastUpdated) overviewLastUpdated.textContent = new Date().toLocaleTimeString();
                
                // Update overview subscriber rate
                const overviewSubscriberRate = document.getElementById('overviewSubscriberRate');
                if (overviewSubscriberRate) {
                    const rate = stats.subscriptionRate || 0;
                    overviewSubscriberRate.textContent = `${rate}% conversion rate`;
                }
                
                // Create overview status chart if Chart.js is available
                if (typeof Chart !== 'undefined') {
                    createOverviewStatusChart(stats.orderStatusDistribution || {});
                }
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        // Create overview status chart
        function createOverviewStatusChart(statusData) {
            const canvas = document.getElementById('overviewStatusChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.overviewChart) {
                window.overviewChart.destroy();
            }
            
            const data = {
                labels: ['Pending', 'Processing', 'Assigned', 'Completed', 'Cancelled'],
                datasets: [{
                    data: [
                        statusData.pending || 0,
                        statusData.processing || 0,
                        statusData.assigned || 0,
                        statusData.completed || 0,
                        statusData.cancelled || 0
                    ],
                    backgroundColor: [
                        '#fed7aa',
                        '#bfdbfe',
                        '#d9f99d',
                        '#bbf7d0',
                        '#fecaca'
                    ],
                    borderColor: [
                        '#c05621',
                        '#1e40af',
                        '#65a30d',
                        '#059669',
                        '#dc2626'
                    ],
                    borderWidth: 1
                }]
            };
            
            window.overviewChart = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // Switch Tabs
        function switchTab(tab) {
            // Prevent default link behavior
            if (event) {
                event.preventDefault();
            }
            
            // Update tab items
            document.querySelectorAll('.tab-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the clicked item
            const clickedItem = event ? event.currentTarget : document.querySelector(`[onclick*="switchTab('${tab}')"]`);
            if (clickedItem) {
                clickedItem.classList.add('active');
            }
            
            // Update content
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(`${tab}Tab`).classList.add('active');
            
            // Load data
            switch(tab) {
                case 'overview':
                    loadStats();
                    break;
                case 'orders':
                    loadOrders();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'customers':
                    loadCustomers();
                    break;
                case 'subscriptions':
                    loadSubscriptions();
                    break;
                case 'pricing':
                    loadPricing();
                    loadEmailConfirmationPrice();
                    loadTransactions();
                    break;
                case 'broadcast':
                    // Broadcast tab doesn't need to load data on switch
                    break;
                case 'settings':
                    updateLastUpdated();
                    loadStuckPayments();
                    checkFallbackStatus();
                    break;
            }
        }

        // Load Orders
        async function loadOrders() {
            const loading = document.getElementById('ordersLoading');
            const tableContainer = document.getElementById('ordersTableContainer');
            const tbody = document.getElementById('ordersTableBody');
            
            loading.style.display = 'block';
            tableContainer.style.display = 'none';
            
            try {
                const response = await apiRequest('/api/admin/orders');
                const orders = await response.json();
                
                // Check if orders is an array
                if (!Array.isArray(orders)) {
                    throw new Error('Invalid response format: orders is not an array');
                }
                
                currentData.orders = orders;
                
                tbody.innerHTML = orders.map(order => `
                    <tr onclick="openOrderDetails('${order.id}')" data-order-id="${order.id}" style="cursor: pointer;">
                        <td>#${order.id.substring(0, 8)}</td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 2px;">
                                <div style="font-weight: 500;">@${order.users?.telegram_username || 'unknown'}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">ID: ${order.users?.telegram_id || 'N/A'}</div>
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 2px;">
                                <div style="font-weight: 500;">${order.customer_name || 'N/A'}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${order.customer_profiles?.email || 'No email'}</div>
                            </div>
                        </td>
                        <td>${order.package_type === 'email_confirmation' ? 'Email Service' : (order.sites_count || order.package_type) + ' sites'}</td>
                        <td>${order.token_cost}</td>
                        <td>
                            <span class="status-badge status-${order.status}">
                                ${order.status}
                            </span>
                        </td>
                        <td>${new Date(order.created_at).toLocaleDateString()}</td>
                        <td onclick="event.stopPropagation();">
                            <div class="actions-menu">
                                <button class="menu-trigger" onclick="toggleActionMenu('${order.id}')">⋯</button>
                                <div class="dropdown-menu" id="menu-${order.id}">
                                    <button class="dropdown-item" onclick="openStatusModal('${order.id}', '${order.status}', '${order.users?.telegram_id}')">Update Status</button>
                                    <button class="dropdown-item danger" onclick="deleteOrder('${order.id}')">Delete Order</button>
                                </div>
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                loading.style.display = 'none';
                tableContainer.style.display = 'block';
            } catch (error) {
                console.error('Error loading orders:', error);
                loading.textContent = 'Error loading orders';
            }
        }

        // Three dots menu functions
        function toggleActionMenu(orderId) {
            const menu = document.getElementById(`menu-${orderId}`);
            const allMenus = document.querySelectorAll('.dropdown-menu');
            
            // Close all other menus
            allMenus.forEach(m => {
                if (m.id !== `menu-${orderId}`) {
                    m.classList.remove('show');
                }
            });
            
            // Toggle current menu
            menu.classList.toggle('show');
        }

        // Close menus when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.actions-menu')) {
                const allMenus = document.querySelectorAll('.dropdown-menu');
                allMenus.forEach(menu => menu.classList.remove('show'));
            }
        });

        // Open status update modal
        function openStatusModal(orderId, currentStatus, telegramId) {
            // Security: Validate status value against allowed enums
            const allowedStatuses = ['pending', 'processing', 'assigned', 'completed', 'cancelled'];
            if (!allowedStatuses.includes(currentStatus)) {
                console.error('Invalid status value:', currentStatus);
                return;
            }

            // Close the dropdown menu
            document.getElementById(`menu-${orderId}`).classList.remove('show');

            // Set modal data
            document.getElementById('statusOrderId').value = orderId;
            document.getElementById('statusTelegramId').value = telegramId;
            
            // Set current status with proper styling and sanitization
            const currentStatusDisplay = document.getElementById('currentStatusDisplay');
            currentStatusDisplay.textContent = currentStatus.charAt(0).toUpperCase() + currentStatus.slice(1);
            
            // Security: Sanitize CSS class name to prevent injection
            const sanitizedStatus = currentStatus.replace(/[^a-z-]/g, '');
            currentStatusDisplay.className = `current-status-badge status-${sanitizedStatus}`;
            
            document.getElementById('statusNotes').value = '';

            // Clear previous selections
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.status === currentStatus) {
                    btn.classList.add('selected');
                }
            });

            // Add click handlers for status buttons
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.onclick = function() {
                    document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                };
            });

            // Show modal
            document.getElementById('statusModal').style.display = 'block';
        }

        // Confirm status update
        function confirmStatusUpdate() {
            const orderId = document.getElementById('statusOrderId').value;
            const telegramId = document.getElementById('statusTelegramId').value;
            const notes = document.getElementById('statusNotes').value || '';
            const selectedBtn = document.querySelector('.status-btn.selected');

            if (!selectedBtn) {
                alert('Please select a status');
                return;
            }

            const newStatus = selectedBtn.dataset.status;
            
            // Security: Validate selected status before sending to server
            const allowedStatuses = ['pending', 'processing', 'assigned', 'completed', 'cancelled'];
            if (!allowedStatuses.includes(newStatus)) {
                console.error('Invalid status selected:', newStatus);
                alert('Invalid status selected');
                return;
            }

            updateOrderStatus(orderId, telegramId, newStatus, notes);
            closeModal('statusModal');
        }

        // Update Order Status
        async function updateOrderStatus(orderId, telegramId, newStatus, notes) {
            
            try {
                const response = await apiRequest(`/api/admin/orders/${orderId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: newStatus, notes })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('success', `Order status updated successfully! ${result.notificationSent ? 'User notified.' : ''}`);
                    loadOrders(); // Reload orders
                    loadStats(); // Update stats
                } else {
                    showMessage('error', result.error || 'Failed to update order status');
                }
            } catch (error) {
                console.error('Error updating order:', error);
                showMessage('error', 'Failed to update order status');
            }
        }

        // Delete Order
        async function deleteOrder(orderId) {
            if (!confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await apiRequest(`/api/admin/orders/${orderId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('success', 'Order deleted successfully');
                    loadOrders();
                    loadStats();
                } else {
                    showMessage('error', 'Failed to delete order');
                }
            } catch (error) {
                console.error('Error deleting order:', error);
                showMessage('error', 'Failed to delete order');
            }
        }

        // Order Details Modal Functions
        function openOrderDetails(orderId) {
            const order = currentData.orders.find(o => o.id === orderId);
            if (!order) {
                console.error('Order not found:', orderId);
                return;
            }

            // Store current order for actions
            window.currentOrderDetails = order;

            // Populate order details modal
            document.getElementById('orderDetailsTitle').textContent = `Order #${order.id.substring(0, 8)}`;
            
            // User info
            document.getElementById('orderUserUsername').textContent = order.users?.telegram_username || 'Unknown';
            document.getElementById('orderUserTelegramId').textContent = order.users?.telegram_id || 'N/A';
            document.getElementById('orderUserFullName').textContent = order.users?.full_name || 'N/A';
            
            // Customer info
            const customer = order.customer_profiles;
            document.getElementById('orderCustomerName').textContent = customer ? 
                `${customer.first_name || ''} ${customer.middle_name || ''} ${customer.last_name || ''}`.trim() : 'N/A';
            document.getElementById('orderCustomerEmail').textContent = customer?.email || 'N/A';
            document.getElementById('orderCustomerPhone').textContent = customer?.phone || 'N/A';
            document.getElementById('orderCustomerAddress').textContent = customer?.address || 'N/A';
            document.getElementById('orderCustomerLocation').textContent = customer ? 
                `${customer.city || ''}, ${customer.state || ''}`.replace(', ', customer.city && customer.state ? ', ' : '') || 'N/A' : 'N/A';
            document.getElementById('orderCustomerPostal').textContent = customer?.postal || 'N/A';
            document.getElementById('orderCustomerGender').textContent = customer?.gender || 'N/A';
            document.getElementById('orderCustomerDob').textContent = formatDateSafe(customer?.dob);
            document.getElementById('orderCustomerPassword').textContent = customer?.password_encrypted || 'None';
            
            // Order info
            document.getElementById('orderOrderId').textContent = order.id;
            document.getElementById('orderPackage').textContent = order.package_type === 'email_confirmation' ? 
                'Email Confirmation Service' : `${order.sites_count || order.package_type} sites`;
            
            // Email confirmation status
            const hasEmailConfirmation = order.package_type === 'email_confirmation' || 
                                        (order.product_name && order.product_name.includes('+ Email Confirmation'));
            document.getElementById('orderEmailConfirmation').innerHTML = hasEmailConfirmation ? 
                '<span class="status-badge status-completed">✅ Included</span>' : 
                '<span class="status-badge" style="background: #f3f4f6; color: #6b7280;">❌ Not Included</span>';
            
            document.getElementById('orderTokenCost').textContent = `${order.token_cost} tokens`;
            document.getElementById('orderStatus').innerHTML = `<span class="status-badge status-${order.status}">${order.status}</span>`;
            document.getElementById('orderCreated').textContent = new Date(order.created_at).toLocaleString();
            document.getElementById('orderNotes').textContent = order.notes || 'No notes';

            // Show modal
            document.getElementById('orderDetailsModal').style.display = 'block';
        }

        function closeOrderDetailsModal() {
            document.getElementById('orderDetailsModal').style.display = 'none';
            window.currentOrderDetails = null;
        }

        function editOrderStatus() {
            const order = window.currentOrderDetails;
            if (!order) return;
            
            closeOrderDetailsModal();
            openStatusModal(order.id, order.status, order.users?.telegram_id);
        }

        function contactUser() {
            const order = window.currentOrderDetails;
            if (!order || !order.users?.telegram_username) {
                showMessage('error', 'Cannot contact user - no Telegram username available');
                return;
            }
            
            const telegramUrl = `https://t.me/${order.users.telegram_username}`;
            window.open(telegramUrl, '_blank');
        }

        function deleteOrderFromModal() {
            const order = window.currentOrderDetails;
            if (!order) return;
            
            closeOrderDetailsModal();
            deleteOrder(order.id);
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('orderDetailsModal');
            if (e.target === modal) {
                closeOrderDetailsModal();
            }
        });

        // Load Users
        async function loadUsers(searchTerm = '') {
            const loading = document.getElementById('usersLoading');
            const tableContainer = document.getElementById('usersTableContainer');
            const tbody = document.getElementById('usersTableBody');
            
            loading.style.display = 'block';
            tableContainer.style.display = 'none';
            
            try {
                let url = '/api/admin/users';
                if (searchTerm && searchTerm.trim()) {
                    url += `?search=${encodeURIComponent(searchTerm.trim())}`;
                }
                
                const response = await apiRequest(url);
                const users = await response.json();
                currentData.users = users;
                
                tbody.innerHTML = '';
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.style.cursor = 'pointer';
                    row.onclick = () => openUserDetails(user.id);
                    
                    row.innerHTML = `
                        <td>${user.telegram_id}</td>
                        <td>${user.telegram_username || 'N/A'}</td>
                        <td>${user.full_name || 'N/A'}</td>
                        <td>${user.token_balance}</td>
                        <td>${user.is_admin ? '✅' : '❌'}</td>
                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                        <td onclick="event.stopPropagation()">
                            <div class="actions-menu">
                                <button class="menu-trigger" onclick="toggleActionMenu('user-${user.id}')">⋯</button>
                                <div class="dropdown-menu" id="menu-user-${user.id}">
                                    <button class="dropdown-item" onclick="viewUserDetails('${user.id}')">👁️ View Details</button>
                                    <button class="dropdown-item" onclick="manageTokens('${user.id}', '${user.full_name || user.telegram_username}', ${user.token_balance})">💰 Manage Tokens</button>
                                    <button class="dropdown-item" onclick="toggleAdmin('${user.id}', ${!user.is_admin})">${user.is_admin ? '🚫 Remove Admin' : '👑 Make Admin'}</button>
                                    <button class="dropdown-item danger" onclick="deleteUser('${user.id}', '${user.full_name || user.telegram_username}')">🗑️ Delete User</button>
                                </div>
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary); padding: 40px;">No users found</td></tr>';
                }
                
                loading.style.display = 'none';
                tableContainer.style.display = 'block';
            } catch (error) {
                console.error('Error loading users:', error);
                loading.textContent = 'Error loading users';
            }
        }

        // Search Users Functions
        let searchTimeout;
        function searchUsers() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = document.getElementById('userSearch').value;
                loadUsers(searchTerm);
            }, 300); // Debounce search by 300ms
        }

        function clearUserSearch() {
            document.getElementById('userSearch').value = '';
            loadUsers(); // Load all users
        }

        // Manage Tokens
        function manageTokens(userId, userName, currentBalance) {
            document.getElementById('tokenUserId').value = userId;
            document.getElementById('tokenUserName').textContent = userName;
            document.getElementById('tokenCurrentBalance').textContent = currentBalance;
            document.getElementById('tokenAmount').value = '';
            document.getElementById('tokenDescription').value = '';
            document.getElementById('tokenModal').style.display = 'block';
        }

        // Token Form Handler
        document.getElementById('tokenForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userId = document.getElementById('tokenUserId').value;
            const amount = parseInt(document.getElementById('tokenAmount').value);
            const description = document.getElementById('tokenDescription').value;
            
            try {
                const response = await apiRequest(`/api/admin/users/${userId}/tokens`, {
                    method: 'PUT',
                    body: JSON.stringify({ amount, description })
                });
                
                if (response.ok) {
                    showMessage('success', 'User tokens updated successfully');
                    closeModal('tokenModal');
                    loadUsers();
                    loadStats();
                } else {
                    showMessage('error', 'Failed to update user tokens');
                }
            } catch (error) {
                console.error('Error updating tokens:', error);
                showMessage('error', 'Failed to update user tokens');
            }
        });

        // User Details Functions
        function openUserDetails(userId) {
            const user = currentData.users.find(u => u.id === userId);
            if (!user) return;

            const adminStatus = user.is_admin ? 'Yes (Admin)' : 'No';
            const createdDate = new Date(user.created_at).toLocaleString();
            const lastUpdated = user.updated_at ? new Date(user.updated_at).toLocaleString() : 'Never';

            alert(`User Details:\n\nID: ${user.id}\nTelegram ID: ${user.telegram_id}\nUsername: @${user.telegram_username || 'N/A'}\nFull Name: ${user.full_name || 'N/A'}\nToken Balance: ${user.token_balance} tokens\nAdmin Access: ${adminStatus}\nCreated: ${createdDate}\nLast Updated: ${lastUpdated}`);
        }

        function viewUserDetails(userId) {
            openUserDetails(userId);
        }

        // Toggle Admin Status
        async function toggleAdmin(userId, makeAdmin) {
            const action = makeAdmin ? 'grant admin access to' : 'remove admin access from';
            if (!confirm(`Are you sure you want to ${action} this user?`)) {
                return;
            }

            try {
                const response = await apiRequest(`/api/admin/users/${userId}/admin`, {
                    method: 'PUT',
                    body: JSON.stringify({ isAdmin: makeAdmin })
                });

                if (response.ok) {
                    showMessage('success', `User admin status updated successfully`);
                    loadUsers();
                } else {
                    showMessage('error', 'Failed to update admin status');
                }
            } catch (error) {
                console.error('Error updating admin status:', error);
                showMessage('error', 'Failed to update admin status');
            }
        }

        // Delete User
        async function deleteUser(userId, userName) {
            const confirmed = confirm(
                `⚠️ WARNING: This action cannot be undone!\n\n` +
                `Are you sure you want to permanently delete user "${userName}"?\n\n` +
                `This will remove all user data including:\n` +
                `• User account\n` +
                `• Customer profiles\n` +
                `• Token transactions\n` +
                `• Subscription data\n\n` +
                `Note: Users with existing orders cannot be deleted.`
            );
            
            if (!confirmed) {
                return;
            }

            try {
                const response = await apiRequest(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage('success', result.message);
                    loadUsers();
                    loadStats(); // Update statistics
                } else {
                    const error = await response.json();
                    showMessage('error', error.error || 'Failed to delete user');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showMessage('error', 'Failed to delete user');
            }
        }

        // Load Customers
        async function loadCustomers() {
            const loading = document.getElementById('customersLoading');
            const tableContainer = document.getElementById('customersTableContainer');
            const tbody = document.getElementById('customersTableBody');
            
            loading.style.display = 'block';
            tableContainer.style.display = 'none';
            
            try {
                const response = await apiRequest('/api/admin/customers');
                const customers = await response.json();
                
                // Check if customers is an array
                if (!Array.isArray(customers)) {
                    throw new Error('Invalid response format: customers is not an array');
                }
                
                currentData.customers = customers;
                
                tbody.innerHTML = '';
                
                customers.forEach(customer => {
                    const row = document.createElement('tr');
                    row.style.cursor = 'pointer';
                    row.onclick = () => openCustomerDetails(customer.id);
                    
                    row.innerHTML = `
                        <td>#${customer.id.substring(0, 8)}</td>
                        <td>${customer.first_name || 'N/A'}</td>
                        <td>${customer.middle_name || 'N/A'}</td>
                        <td>${customer.last_name || 'N/A'}</td>
                        <td>${customer.phone || 'N/A'}</td>
                        <td>${customer.email || 'N/A'}</td>
                        <td>${customer.password_encrypted || 'None'}</td>
                        <td>${customer.address || 'N/A'}</td>
                        <td>${customer.city || 'N/A'}</td>
                        <td>${customer.state || 'N/A'}</td>
                        <td>${customer.postal || 'N/A'}</td>
                        <td>${customer.gender || 'N/A'}</td>
                        <td>${formatDateSafe(customer.dob)}</td>
                        <td>${new Date(customer.registered).toLocaleDateString()}</td>
                        <td onclick="event.stopPropagation()">
                            <div class="actions-menu">
                                <button class="menu-trigger" onclick="toggleActionMenu('customer-${customer.id}')">⋯</button>
                                <div class="dropdown-menu" id="menu-customer-${customer.id}">
                                    <button class="dropdown-item" onclick="viewCustomerDetails('${customer.id}')">👁️ View Details</button>
                                    <button class="dropdown-item" onclick="editCustomer('${customer.id}')">✏️ Edit Customer</button>
                                    <button class="dropdown-item danger" onclick="deleteCustomer('${customer.id}')">🗑️ Delete Customer</button>
                                </div>
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                if (customers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="15" style="text-align: center; color: var(--text-secondary); padding: 40px;">No customers found</td></tr>';
                }
                
                loading.style.display = 'none';
                tableContainer.style.display = 'block';
            } catch (error) {
                console.error('Error loading customers:', error);
                loading.textContent = 'Error loading customers';
            }
        }

        // Customer Details Functions
        function openCustomerDetails(customerId) {
            const customer = currentData.customers.find(c => c.id === customerId);
            if (!customer) return;

            const fullName = [customer.first_name, customer.middle_name, customer.last_name].filter(n => n).join(' ') || 'N/A';
            const dob = formatDateSafe(customer.dob);
            const registered = new Date(customer.registered).toLocaleString();

            alert(`Customer Details:\n\nID: ${customer.id}\nName: ${fullName}\nEmail: ${customer.email || 'N/A'}\nPhone: ${customer.phone || 'N/A'}\nAddress: ${customer.address || 'N/A'}\nCity: ${customer.city || 'N/A'}\nState: ${customer.state || 'N/A'}\nPostal Code: ${customer.postal || 'N/A'}\nGender: ${customer.gender || 'N/A'}\nDate of Birth: ${dob}\nPassword: ${customer.password_encrypted || 'None'}\nRegistered: ${registered}`);
        }

        function viewCustomerDetails(customerId) {
            openCustomerDetails(customerId);
        }

        // Edit Customer
        function editCustomer(customerId) {
            const customer = currentData.customers.find(c => c.id === customerId);
            if (!customer) return;

            document.getElementById('customerId').value = customerId;
            document.getElementById('customerFirstName').value = customer.first_name || '';
            document.getElementById('customerLastName').value = customer.last_name || '';
            document.getElementById('customerPhone').value = customer.phone || '';
            document.getElementById('customerEmail').value = customer.email || '';
            document.getElementById('customerPassword').value = customer.password_encrypted || '';
            document.getElementById('customerAddress').value = customer.address || '';
            document.getElementById('customerCity').value = customer.city || '';
            document.getElementById('customerState').value = customer.state || '';
            document.getElementById('customerPostalCode').value = customer.postal || '';
            document.getElementById('customerModal').style.display = 'block';
        }

        // Customer Form Handler
        document.getElementById('customerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const customerId = document.getElementById('customerId').value;
            const updates = {
                first_name: document.getElementById('customerFirstName').value,
                last_name: document.getElementById('customerLastName').value,
                phone: document.getElementById('customerPhone').value,
                email: document.getElementById('customerEmail').value,
                password_encrypted: document.getElementById('customerPassword').value,
                address: document.getElementById('customerAddress').value,
                city: document.getElementById('customerCity').value,
                state: document.getElementById('customerState').value,
                postal: document.getElementById('customerPostalCode').value
            };
            
            try {
                const response = await apiRequest(`/api/admin/customers/${customerId}`, {
                    method: 'PUT',
                    body: JSON.stringify(updates)
                });
                
                if (response.ok) {
                    showMessage('success', 'Customer updated successfully');
                    closeModal('customerModal');
                    loadCustomers();
                } else {
                    showMessage('error', 'Failed to update customer');
                }
            } catch (error) {
                console.error('Error updating customer:', error);
                showMessage('error', 'Failed to update customer');
            }
        });

        // Delete Customer
        async function deleteCustomer(customerId) {
            const confirmed = confirm(
                '⚠️ Delete Customer\n\n' +
                'Are you sure you want to delete this customer?\n\n' +
                'Note: Customers with existing orders cannot be deleted.\n' +
                'This action cannot be undone.'
            );
            
            if (!confirmed) {
                return;
            }

            try {
                const response = await apiRequest(`/api/admin/customers/${customerId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('success', 'Customer deleted successfully');
                    loadCustomers();
                } else {
                    const error = await response.json();
                    showMessage('error', error.error || 'Failed to delete customer');
                }
            } catch (error) {
                console.error('Error deleting customer:', error);
                showMessage('error', 'Failed to delete customer');
            }
        }

        // Export Customers
        function exportCustomers() {
            window.open(`${API_BASE}/api/admin/customers/export`, '_blank');
        }

        // Load Subscriptions
        async function loadSubscriptions() {
            const loading = document.getElementById('subscriptionsLoading');
            const container = document.getElementById('subscriptionsTableContainer');
            const table = document.getElementById('subscriptionsTable');
            const tbody = document.getElementById('subscriptionsTableBody');
            
            loading.style.display = 'block';
            container.style.display = 'none';
            
            try {
                const response = await apiRequest('/api/admin/subscriptions');
                const subscriptions = await response.json();
                currentData.subscriptions = subscriptions;
                
                tbody.innerHTML = '';
                
                if (subscriptions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--text-secondary); padding: 40px;">No subscriptions found</td></tr>';
                } else {
                    subscriptions.forEach(sub => {
                        const row = document.createElement('tr');
                        row.style.cursor = 'pointer';
                        row.onclick = () => openSubscriptionDetails(sub.id);
                        
                        const statusColor = sub.status === 'active' ? 'success' : 
                                           sub.status === 'expired' ? 'danger' : 'warning';
                        const expiresDate = sub.expires_at ? new Date(sub.expires_at) : null;
                        const isExpired = expiresDate && expiresDate < new Date();
                        const planType = sub.plan_type || sub.type || 'Unknown';
                        
                        // Calculate days remaining
                        let daysRemaining = '-';
                        let diffDays = 0;
                        if (expiresDate) {
                            const today = new Date();
                            const diffTime = expiresDate.getTime() - today.getTime();
                            diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            if (diffDays > 0) {
                                daysRemaining = `${diffDays} days`;
                            } else if (diffDays === 0) {
                                daysRemaining = 'Today';
                            } else {
                                daysRemaining = `Expired ${Math.abs(diffDays)} days ago`;
                            }
                        }
                        
                        row.innerHTML = `
                            <td style="font-family: monospace; font-size: 12px;">${sub.id.substring(0, 8)}...</td>
                            <td>
                                <div style="font-weight: 600;">${sub.users?.full_name || 'N/A'}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">ID: ${sub.user_id.substring(0, 8)}...</div>
                            </td>
                            <td>@${sub.users?.telegram_username || 'N/A'}</td>
                            <td>
                                <span class="status-badge status-${planType.toLowerCase()}">
                                    💳 ${planType.toUpperCase()}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge status-${statusColor}">
                                    ${sub.status === 'active' ? '✅' : sub.status === 'expired' ? '⏰' : '❌'} ${sub.status.toUpperCase()}
                                </span>
                            </td>
                            <td>${new Date(sub.created_at).toLocaleDateString()}</td>
                            <td>${expiresDate ? expiresDate.toLocaleDateString() : 'Never'}</td>
                            <td style="color: ${isExpired ? 'var(--accent-danger)' : diffDays <= 7 ? 'var(--accent-warning)' : 'var(--text-primary)'}; font-weight: 600;">${daysRemaining}</td>
                            <td onclick="event.stopPropagation()">
                                <div class="actions-menu">
                                    <button class="menu-trigger" onclick="toggleActionMenu('subscription-${sub.id}')">⋯</button>
                                    <div class="dropdown-menu" id="menu-subscription-${sub.id}">
                                        <button class="dropdown-item" onclick="viewSubscriptionDetails('${sub.id}')">👁️ View Details</button>
                                        <button class="dropdown-item" onclick="updateSubscriptionModal('${sub.id}')">✏️ Update Status</button>
                                        <button class="dropdown-item" onclick="extendSubscription('${sub.id}')">⏰ Extend</button>
                                        <button class="dropdown-item danger" onclick="cancelSubscription('${sub.id}')">❌ Cancel</button>
                                    </div>
                                </div>
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                }
                
                loading.style.display = 'none';
                container.style.display = 'block';
            } catch (error) {
                console.error('Error loading subscriptions:', error);
                loading.textContent = 'Error loading subscriptions';
                showMessage('error', 'Failed to load subscriptions');
            }
        }

        // Update subscription status
        async function updateSubscriptionStatus(subscriptionId, newStatus) {
            try {
                const response = await apiRequest(`/api/admin/subscriptions/${subscriptionId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (response.ok) {
                    showMessage('success', 'Subscription status updated successfully');
                    loadSubscriptions(); // Reload the table
                } else {
                    showMessage('error', 'Failed to update subscription status');
                }
            } catch (error) {
                console.error('Error updating subscription:', error);
                showMessage('error', 'Failed to update subscription status');
            }
        }

        // Refresh subscriptions
        function refreshSubscriptions() {
            loadSubscriptions();
            showMessage('success', 'Subscriptions refreshed');
        }

        // Load Transactions
        async function loadTransactions() {
            const loading = document.getElementById('transactionsLoading');
            const container = document.getElementById('transactionsTableContainer');
            const table = document.getElementById('transactionsTable');
            const tbody = document.getElementById('transactionsTableBody');
            
            loading.style.display = 'block';
            container.style.display = 'none';
            
            try {
                const response = await apiRequest('/api/admin/transactions');
                const transactions = await response.json();
                currentData.transactions = transactions;
                
                tbody.innerHTML = '';
                
                if (transactions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: var(--text-secondary); padding: 40px;">No transactions found</td></tr>';
                } else {
                    transactions.forEach(transaction => {
                        const row = document.createElement('tr');
                        row.style.cursor = 'pointer';
                        row.onclick = () => openTransactionDetails(transaction.id);
                        
                        // Format transaction type with icon
                        let typeDisplay = transaction.transaction_type;
                        let typeIcon = '';
                        switch(transaction.transaction_type) {
                            case 'purchase':
                                typeIcon = '💳';
                                typeDisplay = 'Purchase';
                                break;
                            case 'spend':
                                typeIcon = '💸';
                                typeDisplay = 'Spend';
                                break;
                            case 'credit':
                                typeIcon = '💰';
                                typeDisplay = 'Credit';
                                break;
                            case 'debit':
                                typeIcon = '💸';
                                typeDisplay = 'Debit';
                                break;
                        }
                        
                        // Format amount with color
                        const amountColor = transaction.amount > 0 ? 'var(--accent-success)' : 'var(--accent-danger)';
                        const amountSign = transaction.amount > 0 ? '+' : '';
                        
                        // Format payment status
                        let statusBadge = '';
                        switch(transaction.payment_status.toLowerCase()) {
                            case 'completed':
                                statusBadge = '<span class="status-badge status-completed">✓ Completed</span>';
                                break;
                            case 'pending':
                                statusBadge = '<span class="status-badge status-pending">⏳ Pending</span>';
                                break;
                            case 'failed':
                                statusBadge = '<span class="status-badge status-cancelled">✗ Failed</span>';
                                break;
                            default:
                                statusBadge = `<span class="status-badge">${transaction.payment_status}</span>`;
                        }
                        
                        row.innerHTML = `
                            <td style="font-family: monospace; font-size: 12px;">${transaction.id.substring(0, 8)}...</td>
                            <td>${transaction.date}</td>
                            <td>
                                <div style="font-weight: 600;">@${transaction.user.telegram_username}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${transaction.user.full_name}</div>
                                <div style="font-size: 11px; color: var(--text-tertiary);">ID: ${transaction.user.telegram_id}</div>
                            </td>
                            <td>${typeIcon} ${typeDisplay}</td>
                            <td style="color: ${amountColor}; font-weight: 600; font-family: monospace;">${amountSign}${transaction.amount}</td>
                            <td style="font-family: monospace;">${transaction.balance_after}</td>
                            <td>${transaction.payment_method || '-'}</td>
                            <td>${statusBadge}</td>
                            <td style="font-family: monospace; font-size: 12px;">${transaction.payment_id || '-'}</td>
                            <td onclick="event.stopPropagation()">
                                <div class="actions-menu">
                                    <button class="menu-trigger" onclick="toggleActionMenu('transaction-${transaction.id}')">⋯</button>
                                    <div class="dropdown-menu" id="menu-transaction-${transaction.id}">
                                        <button class="dropdown-item" onclick="viewTransactionDetails('${transaction.id}')">👁️ View Details</button>
                                        <button class="dropdown-item" onclick="copyTransactionId('${transaction.id}')">📋 Copy ID</button>
                                        ${transaction.payment_status === 'pending' ? `<button class="dropdown-item" onclick="retryTransaction('${transaction.id}')">🔄 Retry</button>` : ''}
                                    </div>
                                </div>
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                }
                
                loading.style.display = 'none';
                container.style.display = 'block';
            } catch (error) {
                console.error('Error loading transactions:', error);
                loading.textContent = 'Error loading transactions';
                showMessage('error', 'Failed to load transactions');
            }
        }

        // Refresh Transactions
        function refreshTransactions() {
            loadTransactions();
            showMessage('success', 'Transactions refreshed');
        }

        // Transaction Actions
        function openTransactionDetails(transactionId) {
            const transaction = currentData.transactions.find(t => t.id === transactionId);
            if (!transaction) return;

            alert(`Transaction Details:\n\nID: ${transaction.id}\nUser: ${transaction.user.full_name} (@${transaction.user.telegram_username})\nType: ${transaction.transaction_type}\nAmount: ${transaction.amount} tokens\nStatus: ${transaction.payment_status}\nDate: ${transaction.date}\nDescription: ${transaction.description || 'N/A'}`);
        }

        function viewTransactionDetails(transactionId) {
            openTransactionDetails(transactionId);
        }

        function copyTransactionId(transactionId) {
            navigator.clipboard.writeText(transactionId).then(() => {
                showMessage('success', 'Transaction ID copied to clipboard');
            }).catch(() => {
                showMessage('error', 'Failed to copy to clipboard');
            });
        }

        async function retryTransaction(transactionId) {
            if (!confirm('Are you sure you want to retry this transaction?')) return;
            
            try {
                const response = await apiRequest(`/api/admin/transactions/${transactionId}/retry`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    showMessage('success', 'Transaction retry initiated');
                    loadTransactions();
                } else {
                    showMessage('error', 'Failed to retry transaction');
                }
            } catch (error) {
                showMessage('error', 'Failed to retry transaction');
            }
        }

        // Subscription Actions
        function openSubscriptionDetails(subscriptionId) {
            const subscription = currentData.subscriptions.find(s => s.id === subscriptionId);
            if (!subscription) return;

            const expiresDate = subscription.expires_at ? new Date(subscription.expires_at).toLocaleDateString() : 'Never';
            alert(`Subscription Details:\n\nID: ${subscription.id}\nUser: ${subscription.users?.full_name || 'N/A'} (@${subscription.users?.telegram_username || 'N/A'})\nType: ${subscription.type || 'Unknown'}\nStatus: ${subscription.status}\nCreated: ${new Date(subscription.created_at).toLocaleDateString()}\nExpires: ${expiresDate}`);
        }

        function viewSubscriptionDetails(subscriptionId) {
            openSubscriptionDetails(subscriptionId);
        }

        function updateSubscriptionModal(subscriptionId) {
            const subscription = currentData.subscriptions.find(s => s.id === subscriptionId);
            if (!subscription) return;

            const newStatus = prompt(`Update subscription status for ${subscription.users?.full_name || 'Unknown'}:\n\nCurrent status: ${subscription.status}\n\nEnter new status (active/expired/cancelled):`, subscription.status);
            
            if (newStatus && ['active', 'expired', 'cancelled'].includes(newStatus.toLowerCase())) {
                updateSubscriptionStatus(subscriptionId, newStatus.toLowerCase());
            } else if (newStatus) {
                showMessage('error', 'Invalid status. Use: active, expired, or cancelled');
            }
        }

        async function extendSubscription(subscriptionId) {
            const days = prompt('Extend subscription by how many days?', '30');
            if (!days || isNaN(days)) return;

            try {
                const response = await apiRequest(`/api/admin/subscriptions/${subscriptionId}/extend`, {
                    method: 'POST',
                    body: JSON.stringify({ days: parseInt(days) })
                });

                if (response.ok) {
                    showMessage('success', `Subscription extended by ${days} days`);
                    loadSubscriptions();
                } else {
                    showMessage('error', 'Failed to extend subscription');
                }
            } catch (error) {
                showMessage('error', 'Failed to extend subscription');
            }
        }

        async function cancelSubscription(subscriptionId) {
            if (!confirm('Are you sure you want to cancel this subscription? This action cannot be undone.')) return;

            try {
                const response = await apiRequest(`/api/admin/subscriptions/${subscriptionId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('success', 'Subscription cancelled');
                    loadSubscriptions();
                } else {
                    showMessage('error', 'Failed to cancel subscription');
                }
            } catch (error) {
                showMessage('error', 'Failed to cancel subscription');
            }
        }

        // Payment Review System Functions
        let currentPaymentForApproval = null;

        async function loadStuckPayments() {
            const loading = document.getElementById('stuckPaymentsLoading');
            const table = document.getElementById('stuckPaymentsTable');
            const tbody = document.getElementById('stuckPaymentsTableBody');
            
            loading.style.display = 'block';
            table.style.display = 'none';
            
            try {
                const response = await apiRequest('/api/admin/stuck-payments');
                const payments = await response.json();
                
                tbody.innerHTML = '';
                
                if (payments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary); padding: 40px;">✅ No stuck payments found</td></tr>';
                } else {
                    payments.forEach(payment => {
                        const row = document.createElement('tr');
                        
                        // Determine risk level based on verification status and age
                        let riskLevel = '';
                        let riskColor = '';
                        if (payment.verification_status === 'verified') {
                            riskLevel = '🟢 Low';
                            riskColor = 'var(--accent-success)';
                        } else if (payment.age_minutes > 120) {
                            riskLevel = '🔴 High';
                            riskColor = 'var(--accent-danger)';
                        } else {
                            riskLevel = '🟡 Medium';
                            riskColor = 'var(--accent-warning)';
                        }
                        
                        // Format verification status
                        let verificationStatus = '';
                        if (payment.verification_status === 'verified') {
                            verificationStatus = '<span style="color: var(--accent-success); font-weight: 600;">✅ Verified</span>';
                        } else if (payment.verification_reason) {
                            verificationStatus = `<span style="color: var(--accent-danger); font-weight: 600;">❌ ${payment.verification_reason}</span>`;
                        } else {
                            verificationStatus = '<span style="color: var(--text-secondary);">⏳ Checking...</span>';
                        }
                        
                        // Format age
                        const ageText = payment.age_minutes > 60 ? 
                            `${Math.round(payment.age_minutes / 60)}h ${payment.age_minutes % 60}m` : 
                            `${payment.age_minutes}m`;
                        
                        row.innerHTML = `
                            <td style="font-family: monospace; font-size: 12px;">${payment.payment_id}</td>
                            <td>
                                <div style="font-weight: 600;">@${payment.users.telegram_username}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${payment.users.full_name}</div>
                                <div style="font-size: 11px; color: var(--text-tertiary);">ID: ${payment.users.telegram_id}</div>
                            </td>
                            <td style="font-weight: 600; font-family: monospace;">${payment.amount} tokens</td>
                            <td style="color: ${payment.age_minutes > 60 ? 'var(--accent-danger)' : 'var(--text-secondary)'}; font-weight: 600;">${ageText}</td>
                            <td>${verificationStatus}</td>
                            <td style="color: ${riskColor}; font-weight: 600;">${riskLevel}</td>
                            <td>
                                ${payment.verification_status === 'verified' ? 
                                    `<button class="btn btn-success" onclick="approvePayment('${payment.payment_id}', ${JSON.stringify(payment).replace(/"/g, '&quot;')})">🔓 Approve</button>` :
                                    `<button class="btn btn-secondary" disabled title="Cannot approve - OxaPay verification failed">🔒 Blocked</button>`
                                }
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                }
                
                // Update stuck payment count
                document.getElementById('stuckPaymentCount').textContent = payments.length;
                
                loading.style.display = 'none';
                table.style.display = 'table';
            } catch (error) {
                console.error('Error loading stuck payments:', error);
                loading.textContent = 'Error loading stuck payments';
                showMessage('error', 'Failed to load stuck payments');
            }
        }

        async function checkFallbackStatus() {
            try {
                const response = await apiRequest('/api/admin/fallback-status');
                const status = await response.json();
                
                document.getElementById('automaticProcessing').textContent = status.automaticProcessing ? 'ENABLED' : 'DISABLED';
                document.getElementById('automaticProcessing').style.color = status.automaticProcessing ? 'var(--accent-danger)' : 'var(--accent-success)';
                
                document.getElementById('verificationMode').textContent = status.securityMode === 'VERIFICATION_REQUIRED' ? 'REQUIRED' : 'DISABLED';
                document.getElementById('fallbackSystemStatus').textContent = status.isRunning ? 'RUNNING' : 'STOPPED';
                
            } catch (error) {
                console.error('Error checking fallback status:', error);
                showMessage('error', 'Failed to check fallback status');
            }
        }

        function refreshStuckPayments() {
            loadStuckPayments();
            showMessage('success', 'Stuck payments refreshed');
        }

        function approvePayment(paymentId, paymentData) {
            currentPaymentForApproval = paymentData;
            
            // Populate the approval modal
            const detailsDiv = document.getElementById('paymentApprovalDetails');
            detailsDiv.innerHTML = `
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; border-left: 4px solid var(--accent-warning);">
                    <h4 style="margin: 0 0 15px 0; color: var(--accent-warning);">⚠️ Payment Approval Required</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <strong>Payment ID:</strong><br>
                            <code style="background: var(--bg-primary); padding: 2px 6px; border-radius: 3px;">${paymentData.payment_id}</code>
                        </div>
                        <div>
                            <strong>Amount:</strong><br>
                            <span style="font-size: 18px; font-weight: bold; color: var(--accent-primary);">${paymentData.amount} tokens</span>
                        </div>
                        <div>
                            <strong>User:</strong><br>
                            @${paymentData.users.telegram_username}<br>
                            <small>${paymentData.users.full_name}</small>
                        </div>
                        <div>
                            <strong>Age:</strong><br>
                            ${paymentData.age_minutes > 60 ? Math.round(paymentData.age_minutes / 60) + ' hours' : paymentData.age_minutes + ' minutes'}
                        </div>
                    </div>
                    <div style="background: var(--bg-primary); padding: 10px; border-radius: 4px;">
                        <strong>OxaPay Status:</strong> 
                        <span style="color: var(--accent-success);">✅ ${paymentData.verification_reason || 'Verified'}</span>
                    </div>
                </div>
            `;
            
            // Clear previous admin note
            document.getElementById('adminNote').value = '';
            
            // Show the modal
            openModal('paymentApprovalModal');
        }

        async function confirmPaymentApproval() {
            if (!currentPaymentForApproval) {
                showMessage('error', 'No payment selected for approval');
                return;
            }
            
            const adminNote = document.getElementById('adminNote').value;
            const approveBtn = document.getElementById('approvePaymentBtn');
            
            approveBtn.disabled = true;
            approveBtn.textContent = '🔄 Processing...';
            
            try {
                const response = await apiRequest('/api/admin/approve-payment', {
                    method: 'POST',
                    body: JSON.stringify({
                        paymentId: currentPaymentForApproval.payment_id,
                        adminNote: adminNote
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', 'Payment approved and processed successfully');
                    closeModal('paymentApprovalModal');
                    loadStuckPayments(); // Refresh the list
                    currentPaymentForApproval = null;
                } else {
                    showMessage('error', result.message || 'Failed to approve payment');
                }
                
            } catch (error) {
                console.error('Error approving payment:', error);
                showMessage('error', 'Failed to approve payment');
            } finally {
                approveBtn.disabled = false;
                approveBtn.textContent = '🔓 Approve Payment';
            }
        }

        // Load Analytics
        function loadAnalytics() {
            // Create sample charts
            createGrowthChart();
            createStatusChart();
        }

        function createGrowthChart() {
            const ctx = document.getElementById('growthChart').getContext('2d');
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#cbd5e1' : '#666666';
            const gridColor = isDark ? '#475569' : '#e2e8f0';
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Users',
                        data: [10, 19, 3, 5, 2, 3],
                        borderColor: isDark ? '#8b5cf6' : '#667eea',
                        backgroundColor: isDark ? 'rgba(139, 92, 246, 0.1)' : 'rgba(102, 126, 234, 0.1)',
                        tension: 0.1
                    }, {
                        label: 'Orders',
                        data: [2, 3, 20, 5, 1, 4],
                        borderColor: isDark ? '#10b981' : '#38a169',
                        backgroundColor: isDark ? 'rgba(16, 185, 129, 0.1)' : 'rgba(56, 161, 105, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        },
                        y: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: textColor }
                        }
                    }
                }
            });
        }

        function createStatusChart() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#cbd5e1' : '#666666';
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Pending', 'Processing', 'Cancelled'],
                    datasets: [{
                        data: [65, 20, 10, 5],
                        backgroundColor: [
                            isDark ? '#10b981' : '#38a169', // Completed - Green
                            isDark ? '#f59e0b' : '#f6ad55', // Pending - Orange
                            isDark ? '#8b5cf6' : '#667eea', // Processing - Purple
                            isDark ? '#ef4444' : '#e53e3e'  // Cancelled - Red
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { 
                                color: textColor,
                                padding: 15
                            }
                        }
                    }
                }
            });
        }

        // Modal Functions
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Show Message
        function showMessage(type, text) {
            const messageEl = document.getElementById(`${type}Message`);
            messageEl.textContent = text;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        // Utility Functions
        function refreshAll() {
            loadStats();
            loadEmailConfirmationPrice();
            const activeTab = document.querySelector('.tab-pane.active').id;
            if (activeTab === 'ordersTab') loadOrders();
            if (activeTab === 'usersTab') loadUsers();
            if (activeTab === 'customersTab') loadCustomers();
            showMessage('success', 'Data refreshed successfully');
        }

        function updateLastUpdated() {
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
        }

        // Helper function to format date without timezone issues
        function formatDateSafe(dateString) {
            if (!dateString) return 'N/A';
            
            // Split YYYY-MM-DD and format as MM/DD/YYYY
            const [year, month, day] = dateString.split('-');
            return `${month}/${day}/${year}`;
        }

        // System Logs Functionality
        let currentLogFile = '';
        let logRefreshInterval = null;
        let isAutoRefreshEnabled = false;
        let currentLogPage = 0;
        let currentLogSearch = '';
        const LOGS_PER_PAGE = 100;

        function showSystemLogs() {
            document.getElementById('logsModal').style.display = 'block';
            loadAvailableLogs();
        }

        async function loadAvailableLogs() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/logs`);
                const data = await response.json();
                
                const selectElement = document.getElementById('logFileSelect');
                selectElement.innerHTML = '<option value="">Select a log file...</option>';
                
                data.files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.name;
                    option.textContent = `${file.name} (${formatFileSize(file.size)}) - ${formatDate(file.modified)}`;
                    selectElement.appendChild(option);
                });
                
                // Auto-select the best log for bot activity monitoring
                let selectedLog = null;
                
                // First priority: Current day's bot log
                const todayBotLogs = data.files.filter(f => f.name.includes('bot-2025-07-03') && f.size > 0);
                if (todayBotLogs.length > 0) {
                    selectedLog = todayBotLogs[0];
                }
                
                // Second priority: Most recent bot log with content
                if (!selectedLog) {
                    const botLogs = data.files.filter(f => f.name.includes('bot-') && f.size > 0);
                    if (botLogs.length > 0) {
                        selectedLog = botLogs[0];
                    }
                }
                
                // Third priority: Admin output log
                if (!selectedLog) {
                    const adminLogs = data.files.filter(f => f.name.includes('admin-out') || f.name.includes('admin-combined'));
                    if (adminLogs.length > 0) {
                        selectedLog = adminLogs[0];
                    }
                }
                
                if (selectedLog) {
                    selectElement.value = selectedLog.name;
                    loadSelectedLog();
                }
            } catch (error) {
                console.error('Failed to load log files:', error);
                showLogError('Failed to load log files');
            }
        }

        async function loadSelectedLog() {
            const selectedFile = document.getElementById('logFileSelect').value;
            if (!selectedFile) {
                document.getElementById('logContent').innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 50px;">
                        Select a log file to view its contents
                    </div>
                `;
                document.getElementById('downloadBtn').disabled = true;
                return;
            }

            currentLogFile = selectedFile;
            currentLogPage = 0;
            currentLogSearch = document.getElementById('logSearch').value;
            
            document.getElementById('downloadBtn').disabled = false;
            
            await loadLogContent();
        }

        async function loadLogContent(isLiveUpdate = false) {
            if (!currentLogFile) return;
            
            // Don't show loading spinner for live updates to avoid flickering
            if (!isLiveUpdate) {
                showLogLoading(true);
            }
            
            try {
                let endpoint;
                let params;
                
                if (isLiveUpdate && isAutoRefreshEnabled) {
                    // For live updates, get the latest entries using tail endpoint
                    params = new URLSearchParams({
                        lines: 50 // Get last 50 lines for live view
                    });
                    endpoint = `${API_BASE}/api/admin/logs/${currentLogFile}/tail?${params}`;
                } else {
                    // For regular loading, use pagination
                    params = new URLSearchParams({
                        lines: LOGS_PER_PAGE,
                        offset: currentLogPage * LOGS_PER_PAGE,
                        search: currentLogSearch
                    });
                    endpoint = `${API_BASE}/api/admin/logs/${currentLogFile}?${params}`;
                }
                
                const response = await fetch(endpoint);
                const data = await response.json();
                
                if (response.ok) {
                    displayLogContent(data, isLiveUpdate);
                    updateLogInfo(data);
                    if (!isLiveUpdate) {
                        updatePagination(data);
                    }
                    
                    // Show live indicator
                    if (isLiveUpdate) {
                        showLiveIndicator();
                    }
                } else {
                    showLogError(data.error || 'Failed to load log content');
                }
            } catch (error) {
                console.error('Failed to load log content:', error);
                if (!isLiveUpdate) {
                    showLogError('Failed to load log content');
                }
            } finally {
                if (!isLiveUpdate) {
                    showLogLoading(false);
                }
            }
        }

        function displayLogContent(data, isLiveUpdate = false) {
            const logContent = document.getElementById('logContent');
            
            if (data.lines.length === 0) {
                logContent.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 50px;">
                        No log entries found${currentLogSearch ? ` matching "${currentLogSearch}"` : ''}
                    </div>
                `;
                return;
            }
            
            const logHtml = data.lines.map((line, index) => {
                const formattedLine = formatLogLine(line);
                const isNew = isLiveUpdate && index >= data.lines.length - 5; // Highlight last 5 entries as new
                const newClass = isNew ? ' log-line-new' : '';
                return `<div class="log-line${newClass}">${formattedLine}</div>`;
            }).join('');
            
            logContent.innerHTML = logHtml;
            
            // Auto-scroll to bottom for live updates
            if (isLiveUpdate && isAutoRefreshEnabled) {
                setTimeout(() => {
                    logContent.scrollTop = logContent.scrollHeight;
                }, 100);
            }
            
            // Show scroll to bottom button if not at bottom
            const scrollBtn = document.getElementById('logScrollToBottom');
            scrollBtn.style.display = data.lines.length > 10 ? 'block' : 'none';
        }

        function formatLogLine(line) {
            // Escape HTML and highlight different log levels
            const escaped = line.replace(/[&<>"']/g, function(match) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[match];
            });
            
            // Color coding for different log levels
            if (line.includes('ERROR') || line.includes('❌')) {
                return `<span style="color: var(--accent-danger);">${escaped}</span>`;
            } else if (line.includes('WARN') || line.includes('⚠️')) {
                return `<span style="color: var(--accent-warning);">${escaped}</span>`;
            } else if (line.includes('SUCCESS') || line.includes('✅')) {
                return `<span style="color: var(--accent-success);">${escaped}</span>`;
            } else if (line.includes('📱') || line.includes('🚀') || line.includes('🔄')) {
                return `<span style="color: var(--accent-primary);">${escaped}</span>`;
            } else {
                return escaped;
            }
        }

        function updateLogInfo(data) {
            const fileInfo = document.getElementById('logFileInfo');
            const stats = document.getElementById('logStats');
            
            fileInfo.textContent = `File: ${data.filename} | Last Modified: ${formatDate(data.lastModified)}`;
            stats.textContent = `Total Lines: ${data.totalLines}${currentLogSearch ? ` | Filtered: ${data.lines.length}` : ''}`;
        }

        function updatePagination(data) {
            const pagination = document.getElementById('logPagination');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const pageInfo = document.getElementById('pageInfo');
            const totalInfo = document.getElementById('totalLinesInfo');
            
            if (data.totalLines > LOGS_PER_PAGE) {
                pagination.style.display = 'flex';
                
                const currentStart = currentLogPage * LOGS_PER_PAGE + 1;
                const currentEnd = Math.min((currentLogPage + 1) * LOGS_PER_PAGE, data.totalLines);
                
                pageInfo.textContent = `${currentStart}-${currentEnd} of ${data.totalLines}`;
                totalInfo.textContent = `Page ${currentLogPage + 1} of ${Math.ceil(data.totalLines / LOGS_PER_PAGE)}`;
                
                prevBtn.disabled = currentLogPage === 0;
                nextBtn.disabled = !data.hasMore;
            } else {
                pagination.style.display = 'none';
            }
        }

        function loadPreviousPage() {
            if (currentLogPage > 0) {
                currentLogPage--;
                loadLogContent();
            }
        }

        function loadNextPage() {
            currentLogPage++;
            loadLogContent();
        }

        function searchLogs() {
            const searchTerm = document.getElementById('logSearch').value;
            if (searchTerm !== currentLogSearch) {
                currentLogSearch = searchTerm;
                currentLogPage = 0;
                loadLogContent();
            }
        }

        function refreshLogs() {
            loadLogContent();
            showMessage('success', 'Logs refreshed');
        }

        function downloadCurrentLog() {
            if (!currentLogFile) return;
            
            const downloadUrl = `${API_BASE}/api/admin/logs/${currentLogFile}/download`;
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = currentLogFile;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            
            if (isAutoRefreshEnabled) {
                clearInterval(logRefreshInterval);
                isAutoRefreshEnabled = false;
                btn.textContent = '▶️ Auto Refresh';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            } else {
                logRefreshInterval = setInterval(() => {
                    if (currentLogFile) {
                        loadLogContent(true); // Pass true for live update
                    }
                }, 2000); // Refresh every 2 seconds for better responsiveness
                
                isAutoRefreshEnabled = true;
                btn.textContent = '⏸️ Stop Auto';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
            }
        }

        function scrollToBottom() {
            const logContent = document.getElementById('logContent');
            logContent.scrollTop = logContent.scrollHeight;
        }

        function showLogLoading(show) {
            document.getElementById('logLoading').style.display = show ? 'block' : 'none';
        }

        function showLogError(message) {
            document.getElementById('logContent').innerHTML = `
                <div style="text-align: center; color: var(--accent-danger); padding: 50px;">
                    <strong>Error:</strong> ${message}
                </div>
            `;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleString();
        }

        function showLiveIndicator() {
            const stats = document.getElementById('logStats');
            const originalText = stats.textContent;
            stats.style.color = 'var(--accent-success)';
            stats.textContent = originalText + ' • 🔴 LIVE';
            
            // Remove live indicator after 1 second
            setTimeout(() => {
                stats.style.color = 'var(--text-secondary)';
                stats.textContent = originalText;
            }, 1000);
        }

        // Clean up intervals when modal is closed
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            
            if (modalId === 'logsModal' && isAutoRefreshEnabled) {
                toggleAutoRefresh(); // Stop auto refresh when closing
            }
        }

        // Theme Toggle Functions
        function initializeTheme() {
            const savedTheme = localStorage.getItem('admin-theme') || 'light';
            applyTheme(savedTheme);
        }


        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
            localStorage.setItem('admin-theme', newTheme);
        }

        function applyTheme(theme) {
            const toggleButton = document.getElementById('themeToggle');
            
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                if (toggleButton) {
                    toggleButton.innerHTML = '☀️ Light Mode';
                }
                updateChartsForTheme('dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                if (toggleButton) {
                    toggleButton.innerHTML = '🌙 Dark Mode';
                }
                updateChartsForTheme('light');
            }
        }

        function updateChartsForTheme(theme) {
            // Update existing charts with new theme colors
            if (typeof Chart !== 'undefined' && Chart.instances.length > 0) {
                Chart.instances.forEach(chart => {
                    if (chart && chart.data) {
                        // Update chart colors based on theme
                        const isDark = theme === 'dark';
                        const textColor = isDark ? '#cbd5e1' : '#666666';
                        const gridColor = isDark ? '#475569' : '#e2e8f0';
                        
                        if (chart.options.scales) {
                            // Update axis colors
                            if (chart.options.scales.x) {
                                chart.options.scales.x.ticks = chart.options.scales.x.ticks || {};
                                chart.options.scales.x.ticks.color = textColor;
                                chart.options.scales.x.grid = chart.options.scales.x.grid || {};
                                chart.options.scales.x.grid.color = gridColor;
                            }
                            if (chart.options.scales.y) {
                                chart.options.scales.y.ticks = chart.options.scales.y.ticks || {};
                                chart.options.scales.y.ticks.color = textColor;
                                chart.options.scales.y.grid = chart.options.scales.y.grid || {};
                                chart.options.scales.y.grid.color = gridColor;
                            }
                        }
                        
                        // Update legend colors
                        if (chart.options.plugins && chart.options.plugins.legend) {
                            chart.options.plugins.legend.labels = chart.options.plugins.legend.labels || {};
                            chart.options.plugins.legend.labels.color = textColor;
                        }
                        
                        chart.update();
                    }
                });
            }
        }

        // Initialize theme on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
        });

        // Navigation Collapse Functions
        let navCollapsed = false;

        function toggleNavCollapse() {
            const tabBar = document.querySelector('.tab-bar');
            const collapseBtn = document.getElementById('navCollapseBtn');
            
            if (!tabBar || !collapseBtn) return;
            
            navCollapsed = !navCollapsed;
            
            if (navCollapsed) {
                tabBar.classList.add('collapsed');
                collapseBtn.innerHTML = '▼';
                collapseBtn.title = 'Show Navigation';
            } else {
                tabBar.classList.remove('collapsed');
                collapseBtn.innerHTML = '☰';
                collapseBtn.title = 'Hide Navigation';
            }
        }

        // Auto-collapse on mobile based on screen size
        function handleResponsiveNavigation() {
            const tabBar = document.querySelector('.tab-bar');
            const collapseBtn = document.getElementById('navCollapseBtn');
            
            if (!tabBar || !collapseBtn) return;
            
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // On mobile, start collapsed and use expanded class to show
                tabBar.classList.remove('collapsed');
                if (!navCollapsed) {
                    tabBar.classList.add('expanded');
                } else {
                    tabBar.classList.remove('expanded');
                }
            } else {
                // On desktop, use normal collapsed class
                tabBar.classList.remove('expanded');
                if (navCollapsed) {
                    tabBar.classList.add('collapsed');
                } else {
                    tabBar.classList.remove('collapsed');
                }
            }
        }

        // Initialize navigation on page load
        window.addEventListener('resize', handleResponsiveNavigation);
        window.addEventListener('load', handleResponsiveNavigation);

        // Pricing Management Functions
        let currentPricingData = [];

        async function loadPricing() {
            const loading = document.getElementById('pricingLoading');
            const table = document.getElementById('pricingTable');
            const tbody = document.getElementById('pricingTableBody');
            const error = document.getElementById('pricingError');

            loading.style.display = 'block';
            table.style.display = 'none';
            error.style.display = 'none';

            try {
                const response = await apiRequest('/api/admin/pricing');
                if (response.ok) {
                    const data = await response.json();
                    currentPricingData = data.packages;
                    displayPricingData(data.packages);
                    table.style.display = 'table';
                } else {
                    throw new Error('Failed to load pricing');
                }
            } catch (error) {
                console.error('Error loading pricing:', error);
                document.getElementById('pricingError').style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        function displayPricingData(packages) {
            const tbody = document.getElementById('pricingTableBody');
            tbody.innerHTML = '';

            packages.forEach((pkg, index) => {
                const discount = Math.round(((pkg.baseTokens - pkg.subscriberTokens) / pkg.baseTokens) * 100);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="package-label">Package ${index + 1}</span></td>
                    <td><input type="number" class="pricing-input" value="${pkg.sites}" onchange="updatePricingField(${index}, 'sites', this.value)" style="width: 80px;"></td>
                    <td><input type="number" class="pricing-input" value="${pkg.baseTokens}" onchange="updatePricingField(${index}, 'baseTokens', this.value)" style="width: 90px;"></td>
                    <td><input type="number" class="pricing-input" value="${pkg.subscriberTokens}" onchange="updatePricingField(${index}, 'subscriberTokens', this.value)" style="width: 90px;"></td>
                    <td><span class="status-badge ${discount >= 30 ? 'success' : discount >= 20 ? 'warning' : 'danger'}">${discount}%</span></td>
                    <td>
                        <button class="remove-package-btn" onclick="removePricingPackage(${index})">Remove</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Add "Add Package" row
            const addRow = document.createElement('tr');
            addRow.className = 'add-package-row';
            addRow.innerHTML = `
                <td colspan="6" style="text-align: center; padding: 15px;">
                    <button class="add-package-btn" onclick="addNewPackage()">
                        <span>+</span> Add New Package
                    </button>
                </td>
            `;
            tbody.appendChild(addRow);
        }

        function updatePricingField(index, field, value) {
            currentPricingData[index][field] = parseInt(value);
            document.getElementById('pricingWarning').style.display = 'block';
            // Re-render to update discount percentage
            displayPricingData(currentPricingData);
        }

        function removePricingPackage(index) {
            if (confirm('Are you sure you want to remove this package?')) {
                currentPricingData.splice(index, 1);
                displayPricingData(currentPricingData);
                document.getElementById('pricingWarning').style.display = 'block';
            }
        }

        function addNewPackage() {
            const newPackage = {
                sites: 100,
                baseTokens: 100,
                subscriberTokens: 60
            };
            currentPricingData.push(newPackage);
            displayPricingData(currentPricingData);
            document.getElementById('pricingWarning').style.display = 'block';
        }

        async function savePricing() {
            try {
                const response = await apiRequest('/api/admin/pricing', {
                    method: 'PUT',
                    body: JSON.stringify({ packages: currentPricingData })
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage('success', result.message);
                    document.getElementById('pricingWarning').style.display = 'block';
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save pricing');
                }
            } catch (error) {
                console.error('Error saving pricing:', error);
                showMessage('error', `Failed to save pricing: ${error.message}`);
            }
        }

        // Analytics Functions
        let analyticsCharts = {};

        async function loadAnalytics() {
            try {
                // Load basic stats first
                const response = await apiRequest('/api/admin/stats');
                const stats = await response.json();
                
                // Update KPI cards
                updateAnalyticsKPIs(stats);
                
                // Load charts
                await Promise.all([
                    loadRevenueChart(),
                    loadStatusChart(stats),
                    loadGrowthChart(),
                    loadPackageChart(),
                    loadPerformanceMetrics()
                ]);
            } catch (error) {
                console.error('Error loading analytics:', error);
                showMessage('error', 'Failed to load analytics data');
            }
        }

        function updateAnalyticsKPIs(stats) {
            // Revenue
            document.getElementById('analyticsRevenue').textContent = `${stats.totalRevenue || 0} tokens`;
            
            // Completion Rate
            document.getElementById('analyticsCompletionRate').textContent = `${stats.completionRate || 0}%`;
            
            // Average Order Value
            document.getElementById('analyticsAvgOrder').textContent = stats.avgOrderValue || 0;
            
            // Active Subscribers
            document.getElementById('analyticsSubscribers').textContent = stats.activeSubscribers || 0;
            document.getElementById('subscriberRate').textContent = `${stats.subscriptionRate || 0}% conversion rate`;
            
            // Performance metrics
            document.getElementById('totalTokens').textContent = (stats.totalTokensInSystem || 0).toLocaleString();
            document.getElementById('recentActivity').textContent = `${stats.recentOrdersCount || 0} orders`;
        }

        async function loadRevenueChart() {
            try {
                const period = document.getElementById('revenuePeriod').value;
                const response = await apiRequest(`/api/admin/analytics/revenue?period=${period}`);
                const data = await response.json();
                
                const ctx = document.getElementById('revenueChart').getContext('2d');
                
                if (analyticsCharts.revenue) {
                    analyticsCharts.revenue.destroy();
                }
                
                analyticsCharts.revenue = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.periods.map(p => p.period),
                        datasets: [{
                            label: 'Total Revenue',
                            data: data.periods.map(p => p.total),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.4
                        }, {
                            label: 'Subscriber Revenue',
                            data: data.periods.map(p => p.subscriber),
                            borderColor: '#38a169',
                            backgroundColor: 'rgba(56, 161, 105, 0.1)',
                            fill: false,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Tokens'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading revenue chart:', error);
            }
        }

        function loadStatusChart(stats) {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            if (analyticsCharts.status) {
                analyticsCharts.status.destroy();
            }
            
            const statusData = stats.orderStatusDistribution || {};
            const labels = Object.keys(statusData);
            const values = Object.values(statusData);
            
            analyticsCharts.status = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            '#fed7aa', // pending
                            '#bfdbfe', // processing
                            '#d9f99d', // assigned
                            '#bbf7d0', // completed
                            '#fecaca'  // cancelled
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        async function loadGrowthChart() {
            try {
                const days = document.getElementById('analyticsDateRange').value;
                const response = await apiRequest(`/api/admin/analytics/trends?days=${days}`);
                const data = await response.json();
                
                const ctx = document.getElementById('growthChart').getContext('2d');
                
                if (analyticsCharts.growth) {
                    analyticsCharts.growth.destroy();
                }
                
                analyticsCharts.growth = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.trends.map(t => t.date),
                        datasets: [{
                            label: 'New Users',
                            data: data.trends.map(t => t.users),
                            borderColor: '#f093fb',
                            backgroundColor: 'rgba(240, 147, 251, 0.1)',
                            fill: true,
                            tension: 0.4
                        }, {
                            label: 'Orders',
                            data: data.trends.map(t => t.orders),
                            borderColor: '#4facfe',
                            backgroundColor: 'rgba(79, 172, 254, 0.1)',
                            fill: false,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading growth chart:', error);
            }
        }

        async function loadPackageChart() {
            try {
                const response = await apiRequest('/api/admin/analytics/performance');
                const data = await response.json();
                
                const ctx = document.getElementById('packageChart').getContext('2d');
                
                if (analyticsCharts.package) {
                    analyticsCharts.package.destroy();
                }
                
                const packages = data.packages || {};
                const labels = Object.keys(packages);
                const values = Object.values(packages).map(p => p.count);
                
                analyticsCharts.package = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels.map(l => `${l} sites`),
                        datasets: [{
                            label: 'Orders',
                            data: values,
                            backgroundColor: [
                                '#667eea', '#f093fb', '#4facfe', '#fa709a',
                                '#fee140', '#38a169', '#e53e3e', '#f6ad55'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading package chart:', error);
            }
        }

        async function loadPerformanceMetrics() {
            try {
                const response = await apiRequest('/api/admin/analytics/performance');
                const data = await response.json();
                
                // Update performance metrics
                document.getElementById('avgProcessingTime').textContent = 
                    `${data.processing.avgProcessingTimeHours || 0}h`;
                document.getElementById('retentionRate').textContent = 
                    `${data.retention.retentionRate || 0}%`;
                    
            } catch (error) {
                console.error('Error loading performance metrics:', error);
            }
        }

        function exportAnalytics() {
            // Simple CSV export functionality
            try {
                const dateRange = document.getElementById('analyticsDateRange').value;
                const exportData = {
                    date: new Date().toISOString(),
                    dateRange: `${dateRange} days`,
                    revenue: document.getElementById('analyticsRevenue').textContent,
                    completionRate: document.getElementById('analyticsCompletionRate').textContent,
                    avgOrderValue: document.getElementById('analyticsAvgOrder').textContent,
                    activeSubscribers: document.getElementById('analyticsSubscribers').textContent
                };
                
                const csvContent = Object.entries(exportData)
                    .map(([key, value]) => `${key},${value}`)
                    .join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analytics-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                showMessage('success', 'Analytics data exported successfully');
            } catch (error) {
                console.error('Export error:', error);
                showMessage('error', 'Failed to export analytics data');
            }
        }

        // Bot Management Functions
        async function checkBotStatus() {
            try {
                const response = await apiRequest('/api/admin/bot-status');
                if (response.ok) {
                    const status = await response.json();
                    updateBotStatusDisplay(status);
                } else {
                    throw new Error('Failed to get bot status');
                }
            } catch (error) {
                console.error('Error checking bot status:', error);
                document.getElementById('botStatus').innerHTML = '<span style="color: red;">❌ Error</span>';
                showMessage('error', 'Failed to check bot status');
            }
        }

        function updateBotStatusDisplay(status) {
            if (status.success) {
                const statusColor = status.status === 'online' ? 'green' : 'red';
                const statusIcon = status.status === 'online' ? '✅' : '❌';
                
                document.getElementById('botStatus').innerHTML = `<span style="color: ${statusColor};">${statusIcon} ${status.status}</span>`;
                
                // Format uptime
                const uptime = status.uptime ? formatUptime(Date.now() - status.uptime) : 'Unknown';
                document.getElementById('botUptime').textContent = uptime;
                
                document.getElementById('botRestarts').textContent = status.restarts || '0';
                
                // Format memory
                const memory = status.memory ? formatBytes(status.memory) : 'Unknown';
                document.getElementById('botMemory').textContent = memory;
            } else {
                document.getElementById('botStatus').innerHTML = '<span style="color: red;">❌ Not Found</span>';
                document.getElementById('botUptime').textContent = '-';
                document.getElementById('botRestarts').textContent = '-';
                document.getElementById('botMemory').textContent = '-';
            }
        }

        function formatUptime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days}d ${hours % 24}h ${minutes % 60}m`;
            if (hours > 0) return `${hours}h ${minutes % 60}m`;
            if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
            return `${seconds}s`;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function restartBot() {
            const confirmed = confirm(
                '⚠️ Bot Restart Confirmation\n\n' +
                'Are you sure you want to restart the Telegram bot?\n\n' +
                'This will:\n' +
                '• Temporarily disconnect all users\n' +
                '• Apply any pricing changes\n' +
                '• Reload all configuration\n' +
                '• Take about 10-15 seconds\n\n' +
                'Continue with restart?'
            );
            
            if (!confirmed) return;

            const restartBtn = document.getElementById('restartBotBtn');
            const originalText = restartBtn.textContent;
            
            try {
                restartBtn.disabled = true;
                restartBtn.textContent = '🔄 Restarting...';
                restartBtn.style.opacity = '0.6';

                const response = await apiRequest('/api/admin/restart-bot', {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage('success', result.message);
                    
                    // Auto-check status after a short delay
                    setTimeout(() => {
                        checkBotStatus();
                    }, 3000);
                    
                    // Re-enable button after longer delay
                    setTimeout(() => {
                        restartBtn.disabled = false;
                        restartBtn.textContent = originalText;
                        restartBtn.style.opacity = '1';
                    }, 10000);
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to restart bot');
                }
            } catch (error) {
                console.error('Error restarting bot:', error);
                showMessage('error', `Failed to restart bot: ${error.message}`);
                
                // Re-enable button on error
                restartBtn.disabled = false;
                restartBtn.textContent = originalText;
                restartBtn.style.opacity = '1';
            }
        }

        // Check bot status when settings tab is opened
        function updateLastUpdated() {
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
            checkBotStatus(); // Auto-check bot status when settings tab opens
        }

        // Auto-refresh
        setInterval(() => {
            if (document.getElementById('dashboard').style.display === 'block') {
                loadStats();
                const activeTab = document.querySelector('.tab-pane.active').id;
                if (activeTab === 'ordersTab') {
                    loadOrders();
                }
            }
        }, 30000); // Refresh every 30 seconds

        // Email Confirmation Pricing Functions
        async function loadEmailConfirmationPrice() {
            try {
                const response = await apiRequest('/api/admin/email-confirmation-price');
                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('emailConfirmationPriceRegular').textContent = result.regularPrice;
                    document.getElementById('emailConfirmationPriceSubscriber').textContent = result.subscriberPrice;
                    document.getElementById('newEmailPriceRegular').placeholder = result.regularPrice;
                    document.getElementById('newEmailPriceSubscriber').placeholder = result.subscriberPrice;
                } else {
                    console.error('Failed to load email confirmation price');
                }
            } catch (error) {
                console.error('Error loading email confirmation price:', error);
            }
        }

        async function updateEmailConfirmationPrice() {
            const newRegularPrice = document.getElementById('newEmailPriceRegular').value;
            const newSubscriberPrice = document.getElementById('newEmailPriceSubscriber').value;

            if (!newRegularPrice || newRegularPrice < 1) {
                showMessage('error', 'Please enter a valid regular price (minimum 1 token)');
                return;
            }

            if (!newSubscriberPrice || newSubscriberPrice < 1) {
                showMessage('error', 'Please enter a valid subscriber price (minimum 1 token)');
                return;
            }

            const confirmed = confirm(`Update email confirmation prices?\nRegular users: ${newRegularPrice} tokens\nSubscribers: ${newSubscriberPrice} tokens`);
            if (!confirmed) {
                return;
            }

            try {
                const response = await apiRequest('/api/admin/email-confirmation-price', {
                    method: 'PUT',
                    body: JSON.stringify({ 
                        regularPrice: parseInt(newRegularPrice),
                        subscriberPrice: parseInt(newSubscriberPrice)
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage('success', result.message);
                    document.getElementById('emailConfirmationPriceRegular').textContent = newRegularPrice;
                    document.getElementById('emailConfirmationPriceSubscriber').textContent = newSubscriberPrice;
                    document.getElementById('newEmailPriceRegular').value = '';
                    document.getElementById('newEmailPriceSubscriber').value = '';
                    document.getElementById('newEmailPriceRegular').placeholder = newRegularPrice;
                    document.getElementById('newEmailPriceSubscriber').placeholder = newSubscriberPrice;
                } else {
                    const error = await response.json();
                    showMessage('error', error.error || 'Failed to update prices');
                }
            } catch (error) {
                console.error('Error updating email confirmation price:', error);
                showMessage('error', 'Failed to update email confirmation price');
            }
        }

        // Payment Monitoring Functions
        async function checkPaymentStatus() {
            try {
                const response = await apiRequest('/api/admin/payment-fallback-status');
                const status = await response.json();
                
                document.getElementById('fallbackStatus').textContent = status.isHealthy ? '✅ Healthy' : '⚠️ Issues Found';
                document.getElementById('stuckPayments').textContent = status.stuckCount;
                document.getElementById('recentPending').textContent = status.recentPendingCount;
                document.getElementById('recentCompleted').textContent = status.recentCompletedCount;
                document.getElementById('lastPaymentCheck').textContent = new Date(status.lastCheck).toLocaleTimeString();
                
                // Legacy stuck payment button code removed for security
                // Payment processing now handled through Payment Review tab
                
            } catch (error) {
                console.error('Error checking payment status:', error);
                document.getElementById('fallbackStatus').textContent = '❌ Error';
            }
        }

        // Legacy processStuckPayments function removed for security
        // Payment processing now handled securely through Payment Review tab

        // Auto-check payment status when settings tab is opened
        function enhanceTabSwitching() {
            const originalSwitchTab = window.switchTab;
            window.switchTab = function(tabName) {
                originalSwitchTab(tabName);
                
                if (tabName === 'settings') {
                    // Check payment status when settings tab is opened
                    setTimeout(checkPaymentStatus, 500);
                }
            };
        }

        // Initialize enhanced tab switching
        enhanceTabSwitching();

        // Broadcast Functions
        const broadcastMessage = document.getElementById('broadcastMessage');
        const charCount = document.getElementById('charCount');

        // Update character count
        if (broadcastMessage) {
            broadcastMessage.addEventListener('input', () => {
                charCount.textContent = broadcastMessage.value.length;
            });
        }

        function previewBroadcast() {
            const title = document.getElementById('broadcastTitle').value;
            const message = document.getElementById('broadcastMessage').value;
            const emoji = document.getElementById('broadcastEmoji').value;
            
            if (!title || !message) {
                showNotification('Please enter both title and message', 'error');
                return;
            }
            
            const previewDiv = document.getElementById('broadcastPreview');
            const previewContent = document.getElementById('previewContent');
            
            // Format preview like Telegram message
            previewContent.innerHTML = `
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent-primary);">
                    <div style="font-weight: bold; margin-bottom: 10px;">
                        ${emoji} ${title}
                    </div>
                    <div style="white-space: pre-wrap;">${message}</div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); color: var(--text-secondary); font-size: 0.9em;">
                        ---<br>
                        🤖 TeleKpr CRM System
                    </div>
                </div>
            `;
            
            previewDiv.style.display = 'block';
        }

        // User Selection Functions
        let allUsers = [];
        let currentPage = 1;
        let usersPerPage = 100;
        let filteredUsers = [];

        // Toggle user selection visibility based on test mode
        document.addEventListener('DOMContentLoaded', function() {
            const testModeCheckbox = document.getElementById('broadcastTestMode');
            const userSelectionSection = document.getElementById('userSelectionSection');
            const batchModeCheckbox = document.getElementById('batchModeEnabled');
            const regularSendBtn = document.querySelector('.btn.success[onclick="sendBroadcast()"]');
            const batchSendBtn = document.getElementById('sendBatchBtn');
            
            testModeCheckbox.addEventListener('change', function() {
                if (testModeCheckbox.checked) {
                    userSelectionSection.style.display = 'none';
                } else {
                    userSelectionSection.style.display = 'block';
                    if (allUsers.length === 0) {
                        loadUsersForSelection();
                    }
                }
            });
            
            // Toggle batch mode button visibility
            batchModeCheckbox.addEventListener('change', function() {
                if (batchModeCheckbox.checked) {
                    regularSendBtn.style.display = 'none';
                    batchSendBtn.style.display = 'block';
                } else {
                    regularSendBtn.style.display = 'block';
                    batchSendBtn.style.display = 'none';
                }
            });
        });

        async function loadUsersForSelection() {
            const loader = document.getElementById('userSelectionLoader');
            const container = document.getElementById('userSelectionContainer');
            
            loader.style.display = 'block';
            container.style.display = 'none';
            
            try {
                const response = await apiRequest('/api/admin/users/broadcast');
                const data = await response.json();
                
                if (data.success) {
                    allUsers = data.users;
                    populateUserSelection(allUsers);
                    updateUserStats();
                } else {
                    throw new Error(data.error || 'Failed to load users');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showNotification('Failed to load users for selection', 'error');
            } finally {
                loader.style.display = 'none';
                container.style.display = 'block';
            }
        }

        function populateUserSelection(users) {
            // Store filtered users for pagination
            filteredUsers = users;
            const totalPages = Math.ceil(users.length / usersPerPage);
            const startIndex = (currentPage - 1) * usersPerPage;
            const endIndex = startIndex + usersPerPage;
            const pageUsers = users.slice(startIndex, endIndex);
            
            const tbody = document.getElementById('userSelectionTableBody');
            tbody.innerHTML = '';
            
            pageUsers.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'user-selection-row';
                
                row.innerHTML = `
                    <td style="text-align: center;">
                        <input type="checkbox" 
                               id="user_${user.id}" 
                               value="${user.id}" 
                               onchange="updateUserStats()">
                    </td>
                    <td>
                        <div style="font-weight: 500;">
                            ${user.name || 'No Name'}
                        </div>
                    </td>
                    <td>
                        <div style="font-family: monospace; color: var(--text-secondary);">
                            @${user.username}
                        </div>
                    </td>
                    <td>
                        <div style="font-family: monospace; color: var(--text-secondary);">
                            ${user.telegram_id}
                        </div>
                    </td>
                    <td style="text-align: center;">
                        ${user.is_admin 
                            ? '<span class="admin-badge">ADMIN</span>' 
                            : '<span style="color: var(--text-tertiary); font-size: 0.85em;">User</span>'
                        }
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Update pagination controls
            updatePaginationControls(users.length, totalPages);
        }

        function updateUserStats(visibleCount = null, searchTerm = '') {
            const allCheckboxes = document.querySelectorAll('#userSelectionTableBody input[type="checkbox"]');
            const visibleCheckboxes = document.querySelectorAll('#userSelectionTableBody tr:not([style*="display: none"]) input[type="checkbox"]');
            const selectedCheckboxes = document.querySelectorAll('#userSelectionTableBody input[type="checkbox"]:checked');
            
            const selectedCount = selectedCheckboxes.length;
            const totalUsers = allCheckboxes.length;
            const visibleUsers = visibleCount !== null ? visibleCount : visibleCheckboxes.length;
            
            // Count admins in selection
            let selectedAdmins = 0;
            selectedCheckboxes.forEach(checkbox => {
                const userId = checkbox.value;
                const user = allUsers.find(u => u.id === userId);
                if (user && user.is_admin) selectedAdmins++;
            });
            
            const selectedRegular = selectedCount - selectedAdmins;
            
            document.getElementById('selectedCount').textContent = selectedCount;
            document.getElementById('visibleUsers').textContent = visibleUsers;
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('adminCount').textContent = `${selectedAdmins} selected`;
            document.getElementById('regularCount').textContent = `${selectedRegular} selected`;
            
            // Show/hide filter stats
            const filterStats = document.getElementById('filterStats');
            const filteredCount = document.getElementById('filteredCount');
            if (searchTerm) {
                filteredCount.textContent = visibleUsers;
                filterStats.style.display = 'inline';
            } else {
                filterStats.style.display = 'none';
            }
            
            // Update the select all checkbox state based on visible checkboxes
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const visibleSelectedCount = document.querySelectorAll('#userSelectionTableBody tr:not([style*="display: none"]) input[type="checkbox"]:checked').length;
            
            if (visibleSelectedCount === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (visibleSelectedCount === visibleUsers) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
                selectAllCheckbox.checked = false;
            }
        }

        function selectAllUsers() {
            const checkboxes = document.querySelectorAll('#userSelectionTableBody input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = true);
            updateUserStats();
        }

        function deselectAllUsers() {
            const checkboxes = document.querySelectorAll('#userSelectionTableBody input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
            updateUserStats();
        }

        function toggleAllUsers(selectAllCheckbox) {
            // Only toggle visible checkboxes when filtering is active
            const checkboxes = document.querySelectorAll('#userSelectionTableBody tr:not([style*="display: none"]) input[type="checkbox"]');
            const isChecked = selectAllCheckbox.checked;
            checkboxes.forEach(checkbox => checkbox.checked = isChecked);
            updateUserStats();
        }

        function selectAdminsOnly() {
            deselectAllUsers();
            allUsers.forEach(user => {
                if (user.is_admin) {
                    const checkbox = document.getElementById(`user_${user.id}`);
                    if (checkbox) checkbox.checked = true;
                }
            });
            updateUserStats();
        }

        function refreshUserList() {
            loadUsersForSelection();
        }

        // Search functionality
        function filterUsers(searchTerm) {
            const searchLower = searchTerm.toLowerCase().trim();
            
            // Reset to first page when searching
            currentPage = 1;
            
            if (!searchTerm) {
                // Show all users if no search term
                populateUserSelection(allUsers);
            } else {
                // Filter users based on search term
                const filtered = allUsers.filter(user => {
                    const name = (user.name || '').toLowerCase();
                    const username = (user.username || '').toLowerCase();
                    const telegramId = (user.telegram_id || '').toString().toLowerCase();
                    
                    return name.includes(searchLower) || 
                           username.includes(searchLower) || 
                           telegramId.includes(searchLower);
                });
                
                populateUserSelection(filtered);
            }
            
            updateUserStats();
        }

        function selectFilteredUsers() {
            const visibleCheckboxes = document.querySelectorAll('#userSelectionTableBody tr:not([style*="display: none"]) input[type="checkbox"]');
            visibleCheckboxes.forEach(checkbox => checkbox.checked = true);
            updateUserStats();
        }

        function clearSearch() {
            document.getElementById('userSearchInput').value = '';
            filterUsers('');
        }

        function getSelectedUserIds() {
            const selectedCheckboxes = document.querySelectorAll('#userSelectionTableBody input[type="checkbox"]:checked');
            return Array.from(selectedCheckboxes).map(checkbox => checkbox.value);
        }
        
        // Pagination functions
        function updatePaginationControls(totalUsers, totalPages) {
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const currentPageSpan = document.getElementById('currentPage');
            const totalPagesSpan = document.getElementById('totalPages');
            const pageRangeStart = document.getElementById('pageRangeStart');
            const pageRangeEnd = document.getElementById('pageRangeEnd');
            const totalUsersCount = document.getElementById('totalUsersCount');
            
            currentPageSpan.textContent = currentPage;
            totalPagesSpan.textContent = totalPages;
            totalUsersCount.textContent = totalUsers;
            
            const startRange = (currentPage - 1) * usersPerPage + 1;
            const endRange = Math.min(currentPage * usersPerPage, totalUsers);
            
            pageRangeStart.textContent = totalUsers > 0 ? startRange : 0;
            pageRangeEnd.textContent = endRange;
            
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
            
            // Show/hide pagination if only one page
            const paginationControls = document.getElementById('paginationControls');
            paginationControls.style.display = totalPages <= 1 ? 'none' : 'flex';
        }
        
        function changePage(direction) {
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                populateUserSelection(filteredUsers);
            }
        }
        
        function selectPageUsers() {
            const pageCheckboxes = document.querySelectorAll('#userSelectionTableBody input[type="checkbox"]');
            pageCheckboxes.forEach(checkbox => checkbox.checked = true);
            updateUserStats();
        }

        async function sendBroadcast() {
            const title = document.getElementById('broadcastTitle').value;
            const message = document.getElementById('broadcastMessage').value;
            const emoji = document.getElementById('broadcastEmoji').value;
            const testMode = document.getElementById('broadcastTestMode').checked;
            
            if (!title || !message) {
                showNotification('Please enter both title and message', 'error');
                return;
            }
            
            // Get selected users if not in test mode
            let selectedUserIds = [];
            let confirmMessage = '';
            let confirmTitle = '';
            
            if (!testMode) {
                selectedUserIds = getSelectedUserIds();
                
                if (selectedUserIds.length === 0) {
                    // No users selected, send to all
                    confirmTitle = 'Send to ALL Users?';
                    confirmMessage = 'No specific users selected. This will send the message to ALL users who have used the bot. Are you sure?';
                } else {
                    // Specific users selected
                    confirmTitle = `Send to ${selectedUserIds.length} Selected Users?`;
                    confirmMessage = `This will send the message to ${selectedUserIds.length} selected users. Are you sure?`;
                }
                
                const confirmed = await showConfirmDialog(
                    confirmTitle,
                    confirmMessage,
                    'Send Message',
                    'danger'
                );
                
                if (!confirmed) return;
            }
            
            const resultDiv = document.getElementById('broadcastResult');
            resultDiv.innerHTML = '<div class="loading">Sending broadcast...</div>';
            resultDiv.style.display = 'block';
            
            // Initialize live logs
            initializeBroadcastLogs();
            
            try {
                const response = await apiRequest('/api/admin/broadcast', {
                    method: 'POST',
                    body: JSON.stringify({
                        title,
                        message,
                        emoji,
                        testMode,
                        selectedUserIds: testMode ? [] : selectedUserIds
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const resultClass = result.sent === result.validTelegramIds ? 'success' : 'warning';
                    resultDiv.innerHTML = `
                        <div class="alert alert-${resultClass}">
                            <h4>✅ Broadcast ${testMode ? 'Test' : 'Live'} Complete!</h4>
                            <p><strong>Total Users:</strong> ${result.totalUsers}</p>
                            <p><strong>Valid Telegram IDs:</strong> ${result.validTelegramIds}</p>
                            <p><strong>Successfully Sent:</strong> ${result.sent}</p>
                            <p><strong>Failed:</strong> ${result.failed}</p>
                            <p><strong>Success Rate:</strong> ${result.successRate}</p>
                            ${testMode && result.users ? `
                                <details style="margin-top: 10px;">
                                    <summary>Test Recipients</summary>
                                    <ul style="margin-top: 5px;">
                                        ${result.users.map(u => `<li>@${u.username || 'Unknown'} - ${u.name}</li>`).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                        </div>
                    `;
                    
                    // Clear form on success
                    if (!testMode) {
                        document.getElementById('broadcastTitle').value = '';
                        document.getElementById('broadcastMessage').value = '';
                        charCount.textContent = '0';
                        document.getElementById('broadcastPreview').style.display = 'none';
                    }
                    
                    showNotification(`Broadcast sent successfully! ${result.sent}/${result.validTelegramIds} delivered`, 'success');
                    
                    // Finalize live logs
                    finalizeBroadcastLogs(result.sent, result.failed, result.successRate);
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-error">
                            <h4>❌ Broadcast Failed</h4>
                            <p>${result.error || 'Unknown error occurred'}</p>
                        </div>
                    `;
                    showNotification('Failed to send broadcast', 'error');
                }
            } catch (error) {
                console.error('Broadcast error:', error);
                resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <h4>❌ Error</h4>
                        <p>${error.message}</p>
                    </div>
                `;
                showNotification('Error sending broadcast', 'error');
            }
        }
        
        async function sendBatchBroadcast() {
            const title = document.getElementById('broadcastTitle').value;
            const message = document.getElementById('broadcastMessage').value;
            const emoji = document.getElementById('broadcastEmoji').value;
            const testMode = document.getElementById('broadcastTestMode').checked;
            
            if (!title || !message) {
                showNotification('Please enter both title and message', 'error');
                return;
            }
            
            // Get selected users if not in test mode
            let selectedUserIds = [];
            let confirmMessage = '';
            let confirmTitle = '';
            
            if (!testMode) {
                selectedUserIds = getSelectedUserIds();
                
                if (selectedUserIds.length === 0) {
                    // No users selected, send to all
                    confirmTitle = 'Send to ALL Users in Batches?';
                    confirmMessage = 'This will send the message to ALL users in batches of 100. This is safer for large broadcasts. Are you sure?';
                } else {
                    // Specific users selected
                    const batches = Math.ceil(selectedUserIds.length / 100);
                    confirmTitle = `Send to ${selectedUserIds.length} Users in ${batches} Batches?`;
                    confirmMessage = `This will send the message to ${selectedUserIds.length} selected users in ${batches} batch(es) of 100 users each. Are you sure?`;
                }
                
                const confirmed = await showConfirmDialog(
                    confirmTitle,
                    confirmMessage,
                    'Send in Batches',
                    'warning'
                );
                
                if (!confirmed) return;
            }
            
            const resultDiv = document.getElementById('broadcastResult');
            resultDiv.innerHTML = '<div class="loading">Starting batch broadcast...</div>';
            resultDiv.style.display = 'block';
            
            // Initialize live logs
            initializeBroadcastLogs();
            
            try {
                const response = await apiRequest('/api/admin/broadcast/batch', {
                    method: 'POST',
                    body: JSON.stringify({
                        title,
                        message,
                        emoji,
                        testMode,
                        selectedUserIds: testMode ? [] : selectedUserIds,
                        batchSize: 100
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const resultClass = result.sent === result.totalUsers ? 'success' : 'warning';
                    resultDiv.innerHTML = `
                        <div class="alert alert-${resultClass}">
                            <h4>✅ Batch Broadcast ${testMode ? 'Test' : 'Live'} Complete!</h4>
                            <p><strong>Total Users:</strong> ${result.totalUsers}</p>
                            <p><strong>Total Batches:</strong> ${result.totalBatches}</p>
                            <p><strong>Batch Size:</strong> ${result.batchSize} users per batch</p>
                            <p><strong>Successfully Sent:</strong> ${result.sent}</p>
                            <p><strong>Failed:</strong> ${result.failed}</p>
                            <p><strong>Success Rate:</strong> ${result.successRate}</p>
                            
                            <details style="margin-top: 15px;">
                                <summary style="cursor: pointer; font-weight: 600;">📊 Batch Details</summary>
                                <div style="margin-top: 10px; max-height: 200px; overflow-y: auto;">
                                    ${result.batches.map(batch => `
                                        <div style="padding: 8px; margin: 5px 0; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.9em;">
                                            <strong>Batch ${batch.batch}:</strong> ${batch.sent}/${batch.users} sent (${batch.successRate})
                                            ${batch.error ? `<br><span style="color: var(--accent-danger);">Error: ${batch.error}</span>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                            
                            ${testMode && result.users ? `
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer;">Test Recipients</summary>
                                    <ul style="margin-top: 5px;">
                                        ${result.users.map(u => `<li>@${u.username || 'Unknown'} - ${u.name}</li>`).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                        </div>
                    `;
                    
                    // Clear form on success
                    if (!testMode) {
                        document.getElementById('broadcastTitle').value = '';
                        document.getElementById('broadcastMessage').value = '';
                        charCount.textContent = '0';
                        document.getElementById('broadcastPreview').style.display = 'none';
                    }
                    
                    showNotification(`Batch broadcast complete! ${result.sent}/${result.totalUsers} delivered in ${result.totalBatches} batches`, 'success');
                    
                    // Finalize live logs
                    finalizeBroadcastLogs(result.sent, result.failed, result.successRate);
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-error">
                            <h4>❌ Batch Broadcast Failed</h4>
                            <p>${result.error || 'Unknown error occurred'}</p>
                        </div>
                    `;
                    showNotification('Failed to send batch broadcast', 'error');
                }
            } catch (error) {
                console.error('Batch broadcast error:', error);
                resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <h4>❌ Error</h4>
                        <p>${error.message}</p>
                    </div>
                `;
                showNotification('Error sending batch broadcast', 'error');
            }
        }

        // Live delivery log functions
        let autoScroll = true;
        let broadcastActive = false;
        let logUpdateInterval;
        
        function initializeBroadcastLogs() {
            const logsDiv = document.getElementById('broadcastLogs');
            logsDiv.style.display = 'block';
            clearDeliveryLogs();
            addLogEntry('🚀 Broadcast starting...', 'info');
            broadcastActive = true;
            
            // Start polling for live logs
            startLogPolling();
        }
        
        function startLogPolling() {
            if (logUpdateInterval) clearInterval(logUpdateInterval);
            
            logUpdateInterval = setInterval(async () => {
                if (!broadcastActive) {
                    clearInterval(logUpdateInterval);
                    return;
                }
                
                try {
                    // This would poll server logs, but for now we'll simulate
                    // In a real implementation, you'd have a /api/admin/broadcast/logs endpoint
                    
                } catch (error) {
                    console.error('Error polling logs:', error);
                }
            }, 500); // Check every 500ms
        }
        
        function addLogEntry(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logsContainer = document.getElementById('deliveryLogs');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            let color = 'var(--text-secondary)';
            let icon = '📝';
            
            switch(type) {
                case 'success':
                    color = 'var(--accent-success)';
                    icon = '✅';
                    break;
                case 'error':
                    color = 'var(--accent-danger)';
                    icon = '❌';
                    break;
                case 'warning':
                    color = 'var(--accent-warning)';
                    icon = '⚠️';
                    break;
                case 'info':
                    color = 'var(--accent-primary)';
                    icon = '📋';
                    break;
            }
            
            logEntry.innerHTML = `
                <span style="color: var(--text-tertiary);">[${timestamp}]</span> 
                <span style="color: ${color};">${icon} ${message}</span>
            `;
            logEntry.style.marginBottom = '4px';
            logEntry.style.lineHeight = '1.4';
            
            logsContainer.appendChild(logEntry);
            
            // Auto-scroll to bottom if enabled
            if (autoScroll) {
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
            
            // Keep only last 100 entries to prevent memory issues
            const entries = logsContainer.querySelectorAll('.log-entry');
            if (entries.length > 100) {
                entries[0].remove();
            }
        }
        
        function clearDeliveryLogs() {
            const logsContainer = document.getElementById('deliveryLogs');
            logsContainer.innerHTML = '<div class="log-entry" style="color: var(--text-secondary);">Logs cleared...</div>';
        }
        
        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            const btn = document.getElementById('autoScrollBtn');
            btn.textContent = `📜 Auto-scroll: ${autoScroll ? 'ON' : 'OFF'}`;
            btn.style.background = autoScroll ? 'var(--accent-success)' : 'var(--accent-secondary)';
        }
        
        function finalizeBroadcastLogs(sent, failed, successRate) {
            broadcastActive = false;
            if (logUpdateInterval) clearInterval(logUpdateInterval);
            
            addLogEntry(`📊 Broadcast complete: ${sent} sent, ${failed} failed (${successRate} success rate)`, 'info');
            addLogEntry('🏁 All deliveries processed', 'success');
        }

        // Utility function to show notifications
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: inherit; cursor: pointer; font-size: 1.2rem;">&times;</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Show notification with animation
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Utility function to show confirmation dialog
        function showConfirmDialog(title, message, confirmText = 'Confirm', type = 'warning') {
            return new Promise((resolve) => {
                // Create modal backdrop
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop';
                backdrop.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;

                // Create modal dialog
                const modal = document.createElement('div');
                modal.className = 'confirm-modal';
                modal.style.cssText = `
                    background: var(--modal-bg, #ffffff);
                    color: var(--modal-color, #333333);
                    padding: 24px;
                    border-radius: 12px;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                    max-width: 400px;
                    width: 90%;
                    text-align: center;
                    animation: modalSlideIn 0.2s ease-out;
                `;

                const typeEmojis = {
                    warning: '⚠️',
                    danger: '🚨',
                    info: 'ℹ️',
                    question: '❓'
                };

                const typeColors = {
                    warning: '#ff9800',
                    danger: '#f44336',
                    info: '#2196f3',
                    question: '#9c27b0'
                };

                modal.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 16px;">
                        ${typeEmojis[type] || typeEmojis.warning}
                    </div>
                    <h3 style="margin: 0 0 12px 0; color: ${typeColors[type] || typeColors.warning};">${title}</h3>
                    <p style="margin: 0 0 24px 0; line-height: 1.5; color: var(--text-secondary, #666);">${message}</p>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button class="cancel-btn" style="
                            padding: 10px 20px;
                            border: 1px solid var(--border-color, #ddd);
                            background: var(--button-secondary-bg, #f5f5f5);
                            color: var(--button-secondary-color, #666);
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            transition: all 0.2s ease;
                        ">Cancel</button>
                        <button class="confirm-btn" style="
                            padding: 10px 20px;
                            border: none;
                            background: ${typeColors[type] || typeColors.warning};
                            color: white;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 500;
                            transition: all 0.2s ease;
                        ">${confirmText}</button>
                    </div>
                `;

                backdrop.appendChild(modal);
                document.body.appendChild(backdrop);

                // Add click handlers
                const cancelBtn = modal.querySelector('.cancel-btn');
                const confirmBtn = modal.querySelector('.confirm-btn');

                const cleanup = () => {
                    backdrop.remove();
                };

                cancelBtn.onclick = () => {
                    cleanup();
                    resolve(false);
                };

                confirmBtn.onclick = () => {
                    cleanup();
                    resolve(true);
                };

                // Close on backdrop click
                backdrop.onclick = (e) => {
                    if (e.target === backdrop) {
                        cleanup();
                        resolve(false);
                    }
                };

                // Close on escape key
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') {
                        cleanup();
                        document.removeEventListener('keydown', handleKeyDown);
                        resolve(false);
                    }
                };
                document.addEventListener('keydown', handleKeyDown);

                // Add CSS animation
                if (!document.querySelector('#modal-animations')) {
                    const style = document.createElement('style');
                    style.id = 'modal-animations';
                    style.textContent = `
                        @keyframes modalSlideIn {
                            from { transform: translateY(-20px); opacity: 0; }
                            to { transform: translateY(0); opacity: 1; }
                        }
                        .confirm-btn:hover {
                            opacity: 0.9 !important;
                            transform: translateY(-1px);
                        }
                        .cancel-btn:hover {
                            background: var(--button-hover-bg, #e0e0e0) !important;
                        }
                    `;
                    document.head.appendChild(style);
                }
            });
        }
    </script>
</body>
</html>